<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checklist de Verticalidad y Estibado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!--
    =============================
    Estilos principales y variables de diseño (CONSOLIDADOS)
    =============================
    -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        /* Paleta de diseño unificada (Coca-Cola FEMSA) */
        :root {
            /* Identidad de Marca */
            --cc-red: #ed1c24;
            --cc-red-dark: #b71c1c;
            --cc-gray: #333;
            --cc-gray-light: #f5f5f5;
            --cc-white: #fff;
            --cc-green: #43a047;

            /* Semántica (Basada en modo claro por defecto) */
            --color-background: var(--cc-gray-light);
            --color-surface: var(--cc-white);
            --color-text: var(--cc-gray);
            --color-text-secondary: #555;
            --color-primary: var(--cc-red);
            --color-primary-dark: var(--cc-red-dark);
            --color-accent: var(--cc-green);

            /* Colores de Stats (para modo oscuro también) */
            --color-blue-bg: rgba(59, 130, 246, 0.1);
            --color-blue-text: #2563eb;
            --color-green-bg: rgba(16, 185, 129, 0.1);
            --color-green-text: #059669;
            --color-red-bg: rgba(239, 68, 68, 0.1);
            --color-red-text: #dc2626;
            --color-amber-bg: rgba(245, 158, 11, 0.1);
            --color-amber-text: #d97706;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #111827; /* Gray 900 */
                --color-surface: #1f2937; /* Gray 800 */
                --color-text: #d1d5db; /* Gray 300 */
                --color-text-secondary: #9ca3af; /* Gray 400 */
                --color-primary: var(--cc-red);
                --color-primary-dark: #f87171; /* Red 400 */
                --color-accent: #34d399; /* Green 400 */

                --color-blue-bg: rgba(96, 165, 250, 0.1);
                --color-blue-text: #60a5fa;
                --color-green-bg: rgba(52, 211, 153, 0.1);
                --color-green-text: #34d399;
                --color-red-bg: rgba(248, 113, 113, 0.1);
                --color-red-text: #f87171;
                --color-amber-bg: rgba(251, 191, 36, 0.1);
                --color-amber-text: #fbbf24;
            }
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background-color: var(--color-background);
            color: var(--color-text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Layout de la App */
        .app-container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        header.app-header { display:flex; flex-direction:column; align-items:center; gap:0.5rem; text-align:center; margin-bottom:1.5rem; }
        .datetime-display { color: var(--color-text-secondary); }

        /* Estilo de la cabecera FEMSA */
        .header-app {
            background: var(--cc-red);
            color: var(--cc-white);
            padding: 0.7rem 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 1px;
            border-radius: 0 0 16px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            width: 100%;
        }

        /* Tarjetas */
        .section-card {
            background: var(--color-surface);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            margin-bottom: 1rem;
            padding: 1rem;
        }
        .table-card {
            background: var(--color-surface);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            margin-top: 1rem;
            padding: 0.5rem;
            overflow: hidden;
        }

        /* Botones de Acción */
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.5rem 0.7rem !important;
            font-size: 1rem !important;
            font-weight: bold;
            border-radius: 8px !important;
            margin-bottom: 0.4rem !important;
            min-width: 140px;
            max-width: 100%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
         .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
         }
        .action-btn:active:not(:disabled) {
            transform: scale(0.97);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .action-btn.red {
            background: var(--color-primary);
            color: var(--cc-white);
        }
        .action-btn.red:hover:not(:disabled) { background: var(--color-primary-dark); }
        .action-btn.gray {
            background: var(--cc-gray);
            color: var(--cc-white);
        }
        .action-btn.gray:hover:not(:disabled) { background: #555; }
        .action-btn.green {
            background: var(--color-accent);
            color: var(--cc-white);
        }
        .action-btn.green:hover:not(:disabled) { background: #388e3c; }
        .action-btn i {
            font-size: 1.1em !important;
            margin-right: 0.5em !important;
        }

        /* Tabs */
        .tab-button.active {
            color: var(--color-primary) !important;
            border-bottom: 2px solid var(--color-primary) !important;
            background: var(--color-surface);
        }
        .tab-button {
            transition: all 0.2s ease;
        }
        .tab-button:focus { outline: 3px solid rgba(237, 28, 36, 0.18); outline-offset: 2px; border-radius: 6px; }


        /* Sticky header para tablas */
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: var(--color-surface);
            z-index: 2;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            width: 95vw;
            max-width: 960px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            border-radius: 12px;
            background-color: var(--color-surface);
            color: var(--color-text);
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translate(-50%, -50%) scale(0.95);
        }
        .modal.active {
            display: block; /* O flex si lo necesitas */
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
         }
        .modal .overflow-y-auto { max-height: calc(90vh - 160px); overflow: auto; }

        /* Backdrop */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.active {
            display: block;
            opacity: 1;
        }

        /* QR reader */
        #qr-reader {
            width: 100%;
            height: 360px;
            max-height: 70vh;
            background: #000;
        }

        /* Previsualización de fotos */
        .photo-preview img { border-radius:6px; object-fit:cover; border:1px solid rgba(0,0,0,0.06); }

        /* Helpers */
        .sr-only { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
        .no-print { display: block; }

        /* =============================
         Toast Notifications (AÑADIDO)
        ============================= */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { display: flex; align-items: center; padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: white; opacity: 0; transform: translateX(100%); transition: all 0.4s ease; font-weight: 500; min-width: 250px; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .toast.error { background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); }
        .toast.info { background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%); }
        .toast i { margin-right: 10px; font-size: 1.2em; }

        /* =============================
         Loader Backdrop (AÑADIDO)
        ============================= */
        .loader-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 9999; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .loader-backdrop.active { display: flex; align-items: center; justify-content: center; opacity: 1; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--cc-red); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* =============================
         Media Query Unificado para Móviles
        ============================= */
        @media (max-width: 640px) {
            .app-container { max-width: 100vw; padding: 0.5rem; }
            .header-app {
                font-size: 1rem;
                padding: 0.7rem 0.5rem;
                border-radius: 0 0 12px 12px;
            }
            .section-card {
                padding: 0.7rem;
                border-radius: 12px;
            }
            .action-btn {
                font-size: 0.95rem;
                padding: 0.7rem !important;
            }
            .table-card {
                padding: 0.2rem;
                border-radius: 12px;
                margin-top: 0.5rem;
            }

            /* Tabs en columna */
            nav.tabs-card ul[role="tablist"] { /* Selector más específico */
                flex-direction: column !important;
                overflow-x: visible !important;
            }
            .tab-button {
                padding: 0.75rem 0.5rem !important;
                font-size: 1rem !important;
                margin-bottom: 0.5rem !important;
                width: 100%;
                border-radius: 8px;
                 border-bottom-width: 0 !important; /* Quitar borde inferior en móvil */
            }
             .tab-button.active {
                 border-bottom-width: 0 !important; /* Asegurar que no haya borde */
                 background: rgba(237, 28, 36, 0.1); /* Fondo ligero rojo para activo */
            }


            /* Modals en móvil */
            .modal {
                width: 98vw !important;
                max-width: 98vw !important;
                max-height: 95vh;
                border-radius: 8px !important;
            }
            .modal .overflow-y-auto { max-height: calc(95vh - 140px) !important; }
            .modal .p-6 { padding: 0.75rem !important; }

            /* Grids a 1 columna */
            .grid-cols-2, .md\:grid-cols-2,
            .grid-cols-3, .md\:grid-cols-3,
            .grid-cols-4, .md\:grid-cols-4,
            .lg\:grid-cols-2, .lg\:grid-cols-5 {
                grid-template-columns: 1fr !important;
            }
            .gap-4, .gap-6 { gap: 0.75rem !important; }

            /* Tablas en móvil */
            table th, table td { padding: 0.3rem 0.5rem !important; font-size: 0.9rem; }

            .photo-preview { height: 2rem !important; width: 2rem !important; }
        }

        /* Estilos de Impresión */
        @media print {
            body {
                background: #fff;
                color: #000;
            }
            .no-print { display:none !important; }
            .app-container { padding: 0; max-width: 100%; }
            .tab-content { display: block !important; } /* Mostrar todo */
             nav.tabs-card { display: none; } /* Ocultar tabs */
            header.app-header { margin-bottom: 0.5rem; }
            .header-app, .section-card, .table-card, .modal {
                box-shadow: none;
                border: 1px solid #ccc;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                 border-radius: 0 !important;
            }
            .action-btn, #searchInput { display: none; } /* Ocultar botones y búsqueda */
             .sticky-header th { position: static; } /* Desactivar sticky header */
             .chart-container { height: 250px !important; max-width: 100% !important; } /* Ajustar charts */
             .overflow-x-auto { overflow: visible !important; } /* Mostrar toda la tabla */
             table { width: 100%; }
             td, th { font-size: 9pt !important; padding: 4px !important; }
             .photo-preview { display: none; } /* Ocultar previews pequeñas */

        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!--
    =============================
    Contenedores de UI (Toast, Loader, Confirm) (AÑADIDOS)
    =============================
    -->
    <div id="toast-container"></div>
    <div id="loader-backdrop" class="loader-backdrop no-print"><div class="loader"></div></div>

    <!-- Modal de Confirmación (AÑADIDO) -->
    <div id="confirm-modal" class="modal no-print" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title" style="max-width: 400px; padding: 1.5rem; text-align: center;">
        <h2 id="confirm-title" class="text-lg font-bold mb-2">Confirmar Acción</h2>
        <p id="confirm-message" class="text-gray-600 dark:text-gray-400 mb-6">¿Estás seguro?</p>
        <div class="flex justify-center gap-4">
            <button id="confirm-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 transition">Cancelar</button>
            <button id="confirm-ok-btn" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">Confirmar</button>
        </div>
    </div>


    <!--
    =============================
    Estructura principal de la aplicación
    =============================
    -->
    <main class="app-container">
        <header class="app-header" role="banner" aria-label="Encabezado del Checklist">
            <!-- Encabezado Coca-Cola FEMSA (Logo de texto) -->
            <div class="header-app">
                <span style="font-size:1.1rem;font-weight:bold;">Checklist de Verticalidad y Estibado</span>
            </div>

            <div id="datetime-display" class="datetime-display" aria-live="polite">
                <i class="fas fa-clock mr-2" aria-hidden="true"></i>
                <span id="current-datetime">Cargando fecha y hora...</span>
            </div>
            <div id="db-status" class="mt-2 text-sm" aria-live="polite"></div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="mb-6 tabs-card section-card no-print" role="navigation" aria-label="Navegación principal">
            <div class="border-b border-gray-200 dark:border-gray-700" aria-label="Pestañas principales">
                    <ul class="flex flex-row flex-nowrap overflow-x-auto sm:flex-col sm:overflow-x-visible -mb-px text-sm font-medium text-center text-gray-500 dark:text-gray-400" role="tablist" style="scrollbar-width: thin;">
                    <li class="mr-2" role="presentation">
                        <button id="tabbutton-verificar" class="tab-button active inline-block p-4 border-b-2 border-sky-600 text-sky-600 hover:text-sky-600 dark:text-sky-400 dark:border-sky-400" data-tab="verificar" type="button" role="tab" aria-controls="tab-verificar" aria-selected="true" tabindex="0">
                            <i class="fas fa-clipboard-check mr-2" aria-hidden="true"></i>Verificar Productos
                        </button>
                    </li>
                    <li class="mr-2" role="presentation">
                        <button id="tabbutton-historial" class="tab-button inline-block p-4 border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300" data-tab="historial" type="button" role="tab" aria-controls="tab-historial" aria-selected="false" tabindex="-1">
                            <i class="fas fa-history mr-2" aria-hidden="true"></i>Historial
                        </button>
                    </li>
                    <li class="mr-2" role="presentation">
                        <button id="tabbutton-estadisticas" class="tab-button inline-block p-4 border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300" data-tab="estadisticas" type="button" role="tab" aria-controls="tab-estadisticas" aria-selected="false" tabindex="-1">
                            <i class="fas fa-chart-bar mr-2" aria-hidden="true"></i>Estadísticas
                        </button>
                    </li>
                    <li class="mr-2" role="presentation">
                        <button id="tabbutton-configuracion" class="tab-button inline-block p-4 border-b-2 border-transparent text-gray-500 hover:text-gray-600 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300" data-tab="configuracion" type="button" role="tab" aria-controls="tab-configuracion" aria-selected="false" tabindex="-1">
                            <i class="fas fa-cog mr-2" aria-hidden="true"></i>Configuración
                        </button>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Tab Content Sections -->

        <!-- Verificar Productos Section -->
        <section id="tab-verificar" class="tab-content active" role="tabpanel" aria-labelledby="tabbutton-verificar" aria-hidden="false">
            <!-- Actions: Search, Export, and Print -->
            <div class="section-card mb-4 sticky top-4 z-10 p-2 bg-opacity-80 backdrop-filter backdrop-blur-sm bg-gray-50 dark:bg-gray-800 rounded-lg no-print" role="region" aria-label="Controles de búsqueda y acciones">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <!-- Search Input -->
                    <div class="relative flex-grow">
                        <label for="searchInput" class="sr-only">Buscar productos por SKU o descripción</label>
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fas fa-search text-gray-400" aria-hidden="true"></i>
                        </span>
                        <input type="text" id="searchInput" placeholder="Buscar por Sku o Descripción..." aria-label="Buscar por SKU o Descripción" class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-2 justify-center sm:justify-end">
                        <button id="scan-qr-main-btn" class="action-btn red" aria-label="Escanear código QR" style="flex:1 1 auto; min-width: 140px;">
                            <i class="fas fa-qrcode" aria-hidden="true"></i>Escanear
                        </button>
                        <button id="commit-session-btn" class="action-btn red" aria-label="Guardar sesión en historial" style="flex:1 1 auto; min-width: 140px;">
                            <i class="fas fa-save" aria-hidden="true"></i>Guardar
                        </button>
                        <button id="export-btn" class="action-btn green" aria-label="Exportar verificaciones seleccionadas" style="flex:1 1 auto; min-width: 140px;">
                            <i class="fas fa-file-excel" aria-hidden="true"></i>Exportar
                        </button>
                        <button id="print-btn" class="action-btn gray" aria-label="Imprimir reporte" style="flex:1 1 auto; min-width: 140px;">
                            <i class="fas fa-print" aria-hidden="true"></i>Imprimir
                        </button>
                    </div>
                </div>
            </div>

            <!-- Product Table -->
            <div class="table-card">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400 sticky-header" role="table" aria-label="Tabla de productos a verificar">
                        <caption class="sr-only">Productos disponibles para verificación</caption>
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-4 py-3">SKU</th>
                                <th scope="col" class="px-4 py-3">Descripción</th>
                                <th scope="col" class="px-4 py-3 text-center">Factor Estiba</th>
                                <th scope="col" class="px-4 py-3 text-center">Estado</th>
                                <th scope="col" class="px-4 py-3 text-center">Ubicación</th>
                                <th scope="col" class="px-4 py-3 text-center">Fotos</th>
                                <th scope="col" class="px-4 py-3 text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" role="rowgroup">
                            <!-- Rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="no-results" class="hidden text-center p-8 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-box-open fa-3x mb-4" aria-hidden="true"></i>
                    <p class="text-lg">No se encontraron productos.</p>
                </div>
            </div>
        </section>

        <!-- Historial Section -->
        <section id="tab-historial" class="tab-content hidden" role="tabpanel" aria-labelledby="tabbutton-historial" aria-hidden="true">
            <!-- History Filters -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6 section-card no-print">
                <h3 class="text-lg font-semibold mb-4">Filtros de Búsqueda</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div>
                        <label for="filter-date-from" class="block text-sm font-medium mb-1">Fecha Desde:</label>
                        <input type="date" id="filter-date-from" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="filter-date-to" class="block text-sm font-medium mb-1">Fecha Hasta:</label>
                        <input type="date" id="filter-date-to" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="filter-sku" class="block text-sm font-medium mb-1">SKU:</label>
                        <input type="text" id="filter-sku" placeholder="Buscar SKU..." class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="filter-inspector" class="block text-sm font-medium mb-1">Inspector:</label>
                        <input type="text" id="filter-inspector" placeholder="Buscar inspector..." class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="filter-status" class="block text-sm font-medium mb-1">Estado:</label>
                        <select id="filter-status" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="">Todos</option>
                            <option value="ok">OK</option>
                            <option value="error">Con Incidencias</option>
                        </select>
                    </div>
                </div>
                <div class="flex flex-wrap justify-between items-center mt-4 gap-2">
                    <button id="apply-filters" class="action-btn red" style="flex: 1 1 auto; min-width: 150px;" aria-label="Aplicar filtros">
                        <i class="fas fa-filter mr-2" aria-hidden="true"></i>Aplicar Filtros
                    </button>
                    <button id="export-history" class="action-btn green" style="flex: 1 1 auto; min-width: 150px;" aria-label="Exportar historial">
                        <i class="fas fa-file-excel mr-2" aria-hidden="true"></i>Exportar Historial
                    </button>
                </div>
            </div>

            <!-- History Table -->
            <div class="table-card">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold">Historial de Verificaciones</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400" id="history-count">0 registros encontrados</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400 sticky-header" role="table" aria-label="Tabla de historial de verificaciones">
                        <caption class="sr-only">Historial de verificaciones guardadas</caption>
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th class="px-4 py-3">Fecha</th>
                                <th class="px-4 py-3">SKU</th>
                                <th class="px-4 py-3">Descripción</th>
                                <th class="px-4 py-3">Estado</th>
                                <th class="px-4 py-3">Inspector</th>
                                <th class="px-4 py-3">Turno</th>
                                <th class="px-4 py-3">Fotos</th>
                                <th class="px-4 py-3">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- Rows dynamically inserted -->
                        </tbody>
                    </table>
                    <div id="no-history" class="hidden text-center p-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-history fa-3x mb-4" aria-hidden="true"></i>
                        <p class="text-lg">No se encontraron registros históricos.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Estadísticas Section -->
        <section id="tab-estadisticas" class="tab-content hidden section-card" role="tabpanel" aria-labelledby="tabbutton-estadisticas" aria-hidden="true">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Summary Cards -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 section-card" aria-label="Resumen general de estadísticas">
                    <h3 class="text-lg font-semibold mb-4">Resumen General</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--color-blue-bg);">
                            <div class="text-2xl font-bold" style="color: var(--color-blue-text);" id="stat-total">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Total Verificaciones</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--color-green-bg);">
                            <div class="text-2xl font-bold" style="color: var(--color-green-text);" id="stat-ok">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">OK</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--color-red-bg);">
                            <div class="text-2xl font-bold" style="color: var(--color-red-text);" id="stat-error">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Con Incidencias</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--color-amber-bg);">
                            <div class="text-2xl font-bold" style="color: var(--color-amber-text);" id="stat-photos">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Fotos Tomadas</div>
                        </div>
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 section-card" aria-label="Estado de verificaciones en gráfico">
                    <h3 class="text-lg font-semibold mb-4">Estados de Verificación</h3>
                    <div class="chart-container" style="height: 300px; position: relative; max-width: 600px; margin: auto; width: 100%;">
                        <canvas id="stats-chart" role="img" aria-label="Gráfico de estados de verificación"></canvas>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 section-card">
                    <h3 class="text-lg font-semibold mb-4">Productos Más Verificados</h3>
                    <div id="top-products" class="space-y-2">
                        <!-- Content dynamically inserted -->
                    </div>
                </div>

                <!-- Top Inspectors -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 section-card">
                    <h3 class="text-lg font-semibold mb-4">Inspectores Más Activos</h3>
                    <div id="top-inspectors" class="space-y-2">
                        <!-- Content dynamically inserted -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Configuración Section -->
        <section id="tab-configuracion" class="tab-content hidden section-card" role="tabpanel" aria-labelledby="tabbutton-configuracion" aria-hidden="true">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Database Management -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 section-card">
                    <h3 class="text-lg font-semibold mb-4">Gestión de Base de Datos</h3>
                    <div class="space-y-4">
                        <div class="p-4 rounded-lg" style="background-color: var(--color-blue-bg);">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Espacio utilizado:</div>
                            <div class="text-lg font-semibold" style="color: var(--color-blue-text);" id="storage-usage" aria-live="polite">Calculando...</div>
                        </div>
                        <!-- Diagnostic Panel: shows DB counts and quick actions -->
                        <div id="diagnostic-panel" class="mt-3 p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50 text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div id="diagnostic-db" class="text-sm text-gray-600 dark:text-gray-400">DB: --</div>
                                    <div id="diagnostic-counts" class="text-sm text-gray-600 dark:text-gray-400">Verificaciones: -- | Fotos: --</div>
                                </div>
                                <div class="flex gap-2">
                                    <button id="refresh-diagnostic-btn" class="action-btn gray px-3 py-1 text-sm">Actualizar diagnóstico</button>
                                </div>
                            </div>
                        </div>
                        <button id="export-all-data" class="action-btn green w-full" aria-label="Exportar toda la base de datos">
                            <i class="fas fa-download mr-2" aria-hidden="true"></i>Exportar Toda la Base de Datos
                        </button>
                        <button id="clean-old-data" class="action-btn gray w-full" aria-label="Limpiar datos antiguos">
                            <i class="fas fa-broom mr-2" aria-hidden="true"></i>Limpiar Datos Antiguos (&gt;6 meses)
                        </button>
                        <button id="clear-all-data" class="action-btn red w-full" aria-label="Limpiar toda la base de datos">
                            <i class="fas fa-trash mr-2" aria-hidden="true"></i>Limpiar Toda la Base de Datos
                        </button>
                    </div>
                </div>

                <!-- App Settings -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 section-card">
                    <h3 class="text-lg font-semibold mb-4">Configuración de la Aplicación</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="photo-quality" class="block text-sm font-medium mb-2">Calidad de fotos:</label>
                            <select id="photo-quality" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="0.8">Alta (0.8)</option>
                                <option value="0.6" selected>Media (0.6)</option>
                                <option value="0.4">Baja (0.4)</option>
                            </select>
                        </div>
                        <div>
                            <label for="photo-max-size" class="block text-sm font-medium mb-2">Tamaño máximo de foto (px):</label>
                            <select id="photo-max-size" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="1920">1920px</option>
                                <option value="1280" selected>1280px</option>
                                <option value="800">800px</option>
                            </select>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium mb-2">Información de la Aplicación</h4>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                <p>Versión: 3.1.0 (Reporte Corporativo)</p>
                                <p>Base de Datos: IndexedDB</p>
                                <p>Capacidad: Estimada localmente</p>
                                <p>Modo: Offline</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- History Detail Modal -->
    <div id="history-detail-modal" class="modal w-11/12 max-w-6xl max-h-[90vh] bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden no-print" role="dialog" aria-modal="true" aria-labelledby="history-modal-title" tabindex="-1">
        <div class="sticky top-0 bg-white dark:bg-gray-800 p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="history-modal-title" class="text-xl font-bold text-sky-600 dark:text-sky-400">Detalles de Verificación</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400" id="history-modal-info"></p>
                </div>
                <button id="close-history-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" aria-label="Cerrar modal de historial">
                    <i class="fas fa-times fa-lg" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        <div class="overflow-y-auto max-h-[calc(90vh-120px)] p-6"> <!-- Ajustado max-height -->
            <div id="history-modal-content"></div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="modal w-11/12 max-w-md bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden no-print" role="dialog" aria-modal="true" aria-labelledby="qr-scanner-title" tabindex="-1">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h2 id="qr-scanner-title" class="text-lg font-bold text-sky-600 dark:text-sky-400">Escanear Código QR</h2>
            <button id="close-qr-scanner-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" aria-label="Cerrar escáner QR">
                <i class="fas fa-times fa-lg" aria-hidden="true"></i>
            </button>
        </div>
        <div class="p-4">
            <div id="qr-reader" class="w-full rounded overflow-hidden"></div> <!-- Added styling -->
            <p id="qr-result" class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400" role="status"></p>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop no-print" aria-hidden="true"></div>

    <!-- Checklist Modal -->
    <div id="checklist-modal" class="modal w-11/12 max-w-4xl max-h-[90vh] bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex flex-col no-print" role="dialog" aria-modal="true" aria-labelledby="checklist-modal-title" tabindex="-1">
        <div class="sticky top-0 bg-white dark:bg-gray-800 p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 id="checklist-modal-title" class="text-xl font-bold text-sky-600 dark:text-sky-400">Checklist de Verticalidad</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400" id="modal-sku"></p>
                </div>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" aria-label="Cerrar modal de checklist">
                    <i class="fas fa-times fa-lg" aria-hidden="true"></i>
                </button>
            </div>

            <div class="mb-4 p-3 rounded-lg bg-sky-100 dark:bg-sky-900/50 flex justify-between items-center">
                <span class="font-semibold">Factor de Estiba Máximo:</span>
                <span class="text-2xl font-bold text-sky-600 dark:text-sky-400" id="modal-factor"></span>
            </div>
        </div>

        <div class="overflow-y-auto flex-grow px-6"> <!-- Use flex-grow for main content area -->
            <form id="checklist-form" aria-label="Formulario de checklist" class="py-6">
                <div class="space-y-6">
                    <!-- Parametros de Checklist - se generan dinámicamente -->
                    <div id="parametros-container"></div>

                    <!-- Campos de Trazabilidad -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Campos de Trazabilidad</h3>

                        <!-- Inspector & Turno -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="inspector" class="block mb-2 text-sm font-medium">Inspector/Responsable:</label>
                                <input type="text" id="inspector" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Nombre del inspector">
                            </div>
                            <div>
                                <label for="turno" class="block mb-2 text-sm font-medium">Turno:</label>
                                <select id="turno" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                    <option value="">Seleccionar turno</option>
                                    <option value="Mañana">Mañana</option>
                                    <option value="Tarde">Tarde</option>
                                    <option value="Noche">Noche</option>
                                </select>
                            </div>
                        </div>

                        <!-- Ubicación -->
                        <div class="mb-4">
                            <label for="location" class="block mb-2 text-sm font-medium">Ubicación:</label>
                            <div class="flex gap-2">
                                <input type="text" id="location" class="flex-1 p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Ej. Rack A3 - Nivel 2">
                                <button type="button" id="gps-btn" class="action-btn px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition font-semibold text-sm flex items-center gap-1" style="flex: 0 0 auto;" aria-label="Obtener ubicación GPS">
                                    <i class="fas fa-map-marker-alt mr-1" aria-hidden="true"></i>
                                    GPS
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ingrese manualmente o use GPS para obtener coordenadas</p>
                        </div>

                        <!-- Observaciones Generales -->
                        <div>
                            <label for="notes" class="block mb-2 text-sm font-medium">Observaciones Generales:</label>
                            <textarea id="notes" rows="3" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Añadir notas adicionales..."></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="sticky bottom-0 bg-white dark:bg-gray-800 p-6 border-t border-gray-200 dark:border-gray-700 mt-auto"> <!-- mt-auto pushes footer down -->
            <div class="flex justify-end space-x-3">
                <button id="cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancelar</button>
                <button id="save-btn" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 transition font-semibold">Guardar Verificación</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("Script loaded"); // Added console log for diagnostics

    // =============================
    // Configuración de la base de datos (IndexedDB)
    // =============================
    const DB_NAME = 'ChecklistDB';
    const DB_VERSION = 1; // Mantener versión estable salvo cambios de esquema
    let db = null;

    // =============================
    // Instancia global para el escáner QR
    // =============================
    let html5QrCode = null;

    // =============================
    // Helper: wait for transaction completion (works with native IndexedDB)
    // =============================
    function waitForTransaction(tx) {
        return new Promise((resolve, reject) => {
            if (!tx) return resolve();
            let finished = false;
            tx.oncomplete = () => { if (!finished) { finished = true; resolve(); } };
            tx.onerror = () => { if (!finished) { finished = true; reject(tx.error || new Error('Transaction error')); } };
            tx.onabort = () => { if (!finished) { finished = true; reject(tx.error || new Error('Transaction aborted')); } };
            // Safety timeout in case events don't fire (very rare)
            setTimeout(() => {
                if (!finished) {
                    finished = true;
                    reject(new Error('Transaction timeout'));
                }
            }, 30000);
        });
    }

    // =============================
    // Inicialización robusta de la base de datos
    // =============================
    async function initDatabase() {
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) {
                updateDbStatus('⚠️ Modo Sin Persistencia (Navegador no compatible)', 'warning');
                showToast('IndexedDB no es compatible con este navegador.', 'error');
                return reject(new Error('IndexedDB no es compatible.'));
            }
            try {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    updateDbStatus('❌ Error de Base de Datos', 'error');
                    console.error("Error al abrir la base de datos:", event.target.error);
                    showToast(`Error de Base de Datos: ${event.target.error}`, 'error');
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    db.onversionchange = () => {
                        db.close();
                        showToast("La base de datos se ha actualizado, por favor recargue la página.", "info");
                    };
                    updateDbStatus('✅ Base de Datos Conectada', 'success');
                    // Run diagnostic when DB is available
                    runDiagnostic().catch(() => {});
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('verificaciones')) {
                        const store = db.createObjectStore('verificaciones', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('sku', 'sku', { unique: false });
                        store.createIndex('fecha', 'fecha', { unique: false });
                        store.createIndex('inspector', 'inspector', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('fotos')) {
                        const store = db.createObjectStore('fotos', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('verificacion_id', 'verificacion_id', { unique: false });
                    }
                };
            } catch (error) {
                updateDbStatus('❌ Error de Base de Datos', 'error');
                console.error("Error al abrir la base de datos:", error);
                showToast(`Error de Base de Datos: ${error.message}`, 'error');
                reject(error);
            }
        });
    }

    // Diagnostic helper: show counts and DB availability
    async function runDiagnostic() {
        const diagDbEl = document.getElementById('diagnostic-db');
        const diagCountsEl = document.getElementById('diagnostic-counts');
        try {
            if (!window.indexedDB) {
                if (diagDbEl) diagDbEl.textContent = 'DB: No disponible (IndexedDB no soportado)';
                if (diagCountsEl) diagCountsEl.textContent = 'Verificaciones: N/A | Fotos: N/A';
                return;
            }
            if (!db) {
                if (diagDbEl) diagDbEl.textContent = 'DB: No inicializada';
            } else {
                if (diagDbEl) diagDbEl.textContent = `DB: Conectada (${DB_NAME})`;
            }

            // Get counts safely
            const verifications = await getAllFromStore('verificaciones').catch(() => []);
            const photos = await getAllFromStore('fotos').catch(() => []);
            if (diagCountsEl) diagCountsEl.textContent = `Verificaciones: ${verifications.length} | Fotos: ${photos.length}`;
        } catch (error) {
            console.error('Diagnostic error:', error);
            if (diagDbEl) diagDbEl.textContent = 'DB: Error';
            if (diagCountsEl) diagCountsEl.textContent = 'Verificaciones: Error | Fotos: Error';
        }
    }

    // =============================
    // Actualiza el estado visual de la base de datos
    // =============================
    function updateDbStatus(message, type) {
        const statusEl = document.getElementById('db-status');
        if (statusEl) {
            let className = 'text-green-600 dark:text-green-400';
            if (type === 'warning') className = 'text-amber-600 dark:text-amber-400';
            if (type === 'error') className = 'text-red-600 dark:text-red-400';
            statusEl.innerHTML = `<span class="${className}">${message}</span>`;
        }
    }

    // =============================
    // Obtiene todos los elementos de un store
    // =============================
    async function getAllFromStore(storeName) {
        return new Promise((resolve, reject) => {
            if (!db) return reject(new Error("La base de datos no está inicializada."));
            const transaction = db.transaction(storeName, 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            request.onerror = event => reject(event.target.error);
            request.onsuccess = event => resolve(event.target.result);
        });
    }

    async function getPhotosForVerification(verificationId) {
        return new Promise((resolve, reject) => {
            if (!db) return reject(new Error("La base de datos no está inicializada."));
            const transaction = db.transaction('fotos', 'readonly');
            const store = transaction.objectStore('fotos');
            const index = store.index('verificacion_id');
            const request = index.getAll(verificationId);
            request.onerror = event => reject(event.target.error);
            request.onsuccess = event => resolve(event.target.result);
        });
    }


    const parametrosChecklist = [
        {id: 1, nombre: 'verticalidad', pregunta: '¿La estiba mantiene la verticalidad?', descripcion: 'Verificar que las botellas mantengan posición vertical (tolerancia: ≤ 0.3 mm)'},
        {id: 2, nombre: 'factor_estiba', pregunta: '¿Cumple con el factor de estiba?', descripcion: 'Altura total / altura referencia ≤ factor máximo'},
        {id: 3, nombre: 'tarima_estado', pregunta: '¿La tarima está en buen estado?', descripcion: 'Sin daños, superficie plana, limpia, sin astillas'},
        {id: 4, nombre: 'producto_integro', pregunta: '¿El producto y empaque están íntegros?', descripcion: 'Botellas sin deformaciones, etiquetas adheridas, empaques sin roturas'},
        {id: 5, nombre: 'perpendicularidad', pregunta: '¿Perpendicularidad de botellas individuales es correcta?', descripcion: 'Medición con instrumento calibrado (≤ 0.3 mm desviación)'},
        {id: 6, nombre: 'alineacion_capas', pregunta: '¿Alineación de capas en la estiba es correcta?', descripcion: 'Cajas alineadas verticalmente, sin desplazamientos laterales'},
        {id: 7, nombre: 'estabilidad_lateral', pregunta: '¿La estiba tiene estabilidad al empuje lateral?', descripcion: 'Resistencia a fuerzas laterales, mantiene verticalidad'},
        {id: 8, nombre: 'altura_uniforme', pregunta: '¿La altura de la estiba es uniforme?', descripcion: 'Variación máxima entre puntos ≤ 5 mm'},
        {id: 9, nombre: 'film_condition', pregunta: '¿Film retráctil/flejado en buena condición?', descripcion: 'Tensión adecuada, sin roturas, cobertura completa'},
        {id: 10, nombre: 'ubicacion_correcta', pregunta: '¿Ubicación correcta en almacén?', descripcion: 'Posición adecuada según procedimientos de almacenamiento'}
    ];

    const productTemplates = [
        {sku: "360", descripcion: "COCA  COLA 600 ML 24 PK", factorEstiba: "2.5"}, {sku: "376", descripcion: "CC PET 2L NO RET 8 PK", factorEstiba: "2.5"},
        {sku: "396", descripcion: "COCA LIGHT 2 LT PET NR 8 C", factorEstiba: "2.5"}, {sku: "445", descripcion: "COCA COLA 3 LT PET NR 4 PK", factorEstiba: "2.5"},
        {sku: "500", descripcion: "CC 2.5L NO RET 8 PACK", factorEstiba: "2.5"}, {sku: "501", descripcion: "COCA COLA 2.5 LT REF-PET 8 CJ", factorEstiba: "3.0"},
        {sku: "610", descripcion: "COCA COLA 600ML PETNR 12PK", factorEstiba: "2.0"}, {sku: "614", descripcion: "FRESCA 2L PET NR 8PK", factorEstiba: "2.5"},
        {sku: "615", descripcion: "FRESCA 600ML PET NR 24PK", factorEstiba: "2.5"}, {sku: "640", descripcion: "SIDRAL MUNDET 600ML NR", factorEstiba: "2.5"},
        {sku: "641", descripcion: "SIDRAL MUNDET 2L NR 8PK", factorEstiba: "2.5"}, {sku: "658", descripcion: "FANTA 600ML PET NR 24PK", factorEstiba: "2.5"},
        {sku: "665", descripcion: "FANTA 2L PET NR 8PK", factorEstiba: "2.5"}, {sku: "674", descripcion: "SPRITE 600ML PET NR 24PK", factorEstiba: "2.5"},
        {sku: "675", descripcion: "SPRITE 2L PET NR 8PK", factorEstiba: "2.5"}, {sku: "702", descripcion: "CC SIN AZUCAR 600ML NR 24PK", factorEstiba: "2.5"},
        {sku: "711", descripcion: "CC SIN AZUCAR 2L NR 8PK", factorEstiba: "2.5"}, {sku: "854", descripcion: "DELAWARE PUNCH 600ML", factorEstiba: "2.5"},
        {sku: "872", descripcion: "TOPO CHICO SANGRIA 600", factorEstiba: "2.5"}, {sku: "874", descripcion: "TOPO CHICO TORONJA 600", factorEstiba: "2.5"},
        {sku: "908", descripcion: "CIEL AGUA NAT 600ML 24PK", factorEstiba: "3.0"}, {sku: "909", descripcion: "CIEL AGUA NAT 1L 12PK", factorEstiba: "3.0"},
        {sku: "910", descripcion: "CIEL AGUA NAT 1.5L 12PK", factorEstiba: "3.0"}, {sku: "945", descripcion: "CIEL SAB JAMAICA 1L 12PK", factorEstiba: "3.0"},
        {sku: "946", descripcion: "CIEL SAB LIMON 1L 12PK", factorEstiba: "3.0"}, {sku: "947", descripcion: "CIEL SAB MANDARINA 1L 12PK", factorEstiba: "3.0"},
        {sku: "983", descripcion: "POWERADE MORAS 500ML 24PK", factorEstiba: "2.5"}, {sku: "984", descripcion: "POWERADE LIMA LIMON 500ML 24PK", factorEstiba: "2.5"},
        {sku: "986", descripcion: "POWERADE UVA 500ML 24PK", factorEstiba: "2.5"}, {sku: "987", descripcion: "POWERADE NARANJA 500ML 24PK", factorEstiba: "2.5"},
        {sku: "989", descripcion: "POWERADE MORAS 1L 12PK", factorEstiba: "2.5"}, {sku: "990", descripcion: "POWERADE UVA 1L 12PK", factorEstiba: "2.5"},
        {sku: "992", descripcion: "POWERADE NARANJA 1L 12PK", factorEstiba: "2.5"}, {sku: "994", descripcion: "POWERADE LIMA LIMON 1L 12PK", factorEstiba: "2.5"},
        {sku: "1119", descripcion: "COCA COLA 1.75 ML PET NR 8 PACK", factorEstiba: "2.0"}, {sku: "1511", descripcion: "VITAMIN WATER XXX 500ML 24P", factorEstiba: "2.5"},
        {sku: "1512", descripcion: "VITAMIN WATER POWER-C 500ML 24P", factorEstiba: "2.5"}, {sku: "1513", descripcion: "VITAMIN WATER ENERGY 500ML 24P", factorEstiba: "2.5"},
        {sku: "1514", descripcion: "VITAMIN WATER FOCUS 500ML 24P", factorEstiba: "2.5"}, {sku: "1515", descripcion: "VITAMIN WATER ESSENTIAL 500ML 24P", factorEstiba: "2.5"},
        {sku: "1516", descripcion: "VITAMIN WATER RESTORE 500ML 24P", factorEstiba: "2.5"}, {sku: "2352", descripcion: "CC COLA BOT 3L RET PET 6p", factorEstiba: "3.0"},
        {sku: "2898", descripcion: "Coca Cola SA 2.5 LT REF PET 8PK", factorEstiba: "2.5"}, {sku: "2908", descripcion: "COCA-COLA 2.25L PNR 8 pk", factorEstiba: "2.0"},
        {sku: "2909", descripcion: "COCA-COLA 1.35L PET NR 12 pk", factorEstiba: "2.0"}, {sku: "3019", descripcion: "Coca Cola Original 2.75L $35 4pk", factorEstiba: "2.0"},
        {sku: "3276", descripcion: "CC COLA BOT 3L RET PET 6p Preciada", factorEstiba: "3.0"},
        {sku: "99938", descripcion: "FANTA NARANJA 2.5 LT REF PET 8PK", factorEstiba: "3.0"},
        {sku: "99939", descripcion: "SIDRAL MUNDET 2.5 LT REF PET 8PK", factorEstiba: "3.0"},
        {sku: "99940", descripcion: "FRESCA 2.5 LT REF PET 8PK", factorEstiba: "3.0"}
    ];

    // =============================
    // Crea el estado inicial de cada producto para la sesión
    // =============================
    const createInitialProductState = (template) => {
        const initialState = {
            ...template,
            status: "pending", notes: "", ubicacion: "", inspector: "", turno: "", fotos_adjuntas: 0, fotos: {}, parametros: {}
        };
        parametrosChecklist.forEach(p => { initialState.parametros[p.nombre] = ""; });
        return initialState;
    };

    // Estado principal de productos
    let products = productTemplates.map(createInitialProductState);

    function resizeImage(file, maxSize = 1280, quality = 0.6) {
        return new Promise((resolve, reject) => { // Added reject
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = function() {
                    try {
                        let { width, height } = img;
                        if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; }}
                        else { if (height > maxSize) { width *= maxSize / height; height = maxSize; }}
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                             if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error("Canvas toBlob returned null"));
                            }
                        }, 'image/jpeg', quality);
                    } catch (loadError) {
                        console.error("Error during image processing:", loadError);
                        reject(loadError);
                    } finally {
                        // <!-- [INICIO] CORRECCIÓN DE FUGA DE MEMORIA -->
                        // Revoca el Object URL para liberar memoria, ya sea que la carga/procesamiento
                        // haya sido exitosa o haya fallado.
                        URL.revokeObjectURL(img.src);
                        // <!-- [FIN] CORRECCIÓN DE FUGA DE MEMORIA -->
                    }
                };
                 img.onerror = function(errorEvent) { // Handle image loading errors
                     console.error("Error loading image for resizing:", errorEvent);
                     // <!-- [INICIO] CORRECCIÓN DE FUGA DE MEMORIA -->
                     // También revoca aquí en caso de error de carga
                     URL.revokeObjectURL(img.src);
                     // <!-- [FIN] CORRECCIÓN DE FUGA DE MEMORIA -->
                     reject(new Error("Failed to load image for resizing"));
                 };
                img.src = URL.createObjectURL(file);
             } catch (setupError) {
                 console.error("Error setting up image resizing:", setupError);
                 reject(setupError);
             }
        });
    }
    function blobToBase64(blob) {
        return new Promise((resolve, reject) => { // Added reject
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
             reader.onerror = (error) => reject(error); // Handle reader errors
            reader.readAsDataURL(blob);
        });
    }

    // =============================
    // Cambia la pestaña activa y carga el contenido correspondiente
    // =============================
    function switchTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(btn => {
            const isActive = btn.dataset.tab === tabName;
            btn.classList.toggle('active', isActive);
            btn.classList.toggle('border-sky-600', isActive); // Mantiene el estilo activo original
            btn.classList.toggle('text-sky-600', isActive); // Mantiene el estilo activo original
            btn.classList.toggle('dark:border-sky-400', isActive); // Mantiene el estilo activo original
            btn.classList.toggle('dark:text-sky-400', isActive); // Mantiene el estilo activo original
            btn.classList.toggle('border-transparent', !isActive);
            btn.classList.toggle('text-gray-500', !isActive); // Mantiene estilo inactivo original
            btn.classList.toggle('hover:text-gray-600', !isActive); // Mantiene estilo inactivo original
            btn.classList.toggle('hover:border-gray-300', !isActive); // Mantiene estilo inactivo original
            btn.classList.toggle('dark:text-gray-400', !isActive); // Mantiene estilo inactivo original
            btn.classList.toggle('dark:hover:text-gray-300', !isActive); // Mantiene estilo inactivo original
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            btn.setAttribute('tabindex', isActive ? '0' : '-1');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `tab-${tabName}`);
            content.classList.toggle('hidden', content.id !== `tab-${tabName}`);
            content.setAttribute('aria-hidden', content.id !== `tab-${tabName}`);
        });
        // Cargar contenido dinámicamente
        if (tabName === 'historial') {
            loadHistoryContent();
        } else if (tabName === 'estadisticas') {
            loadStatistics();
        } else if (tabName === 'configuracion') {
            loadConfiguration();
        }
    }


    // =============================
    // Carga el historial de verificaciones desde la base de datos
    // =============================
    async function loadHistoryContent() {
        const historyTableBody = document.getElementById('history-table-body');
        const noHistoryDiv = document.getElementById('no-history');
        const historyCount = document.getElementById('history-count');
        historyTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Cargando historial... <i class="fas fa-spinner fa-spin"></i></td></tr>'; // Added spinner
        noHistoryDiv.classList.add('hidden'); // Hide initially

        try {
            const dateFromEl = document.getElementById('filter-date-from');
            const dateToEl = document.getElementById('filter-date-to');
            const skuEl = document.getElementById('filter-sku');
            const inspectorEl = document.getElementById('filter-inspector');
            const statusElFilter = document.getElementById('filter-status');
            const filters = {
                dateFrom: dateFromEl?.value ?? '',
                dateTo: dateToEl?.value ?? '',
                sku: skuEl?.value?.toLowerCase().trim() ?? '',
                inspector: inspectorEl?.value?.toLowerCase().trim() ?? '',
                status: statusElFilter?.value ?? ''
            };

            let verifications = await getAllFromStore('verificaciones');

            // Filtrado en cliente
            verifications = verifications.filter(v => {
                 const fechaVerificacion = v.fecha.split('T')[0];
                 if (filters.dateFrom && fechaVerificacion < filters.dateFrom) return false;
                 if (filters.dateTo && fechaVerificacion > filters.dateTo) return false;
                 // Use includes for partial matching
                 if (filters.sku && !v.sku.toLowerCase().includes(filters.sku)) return false;
                 if (filters.inspector && !(v.inspector && v.inspector.toLowerCase().includes(filters.inspector))) return false;
                 if (filters.status && v.status !== filters.status) return false;
                 return true;
            });


            verifications.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            renderHistoryTable(verifications);
        } catch (error) {
            console.error('Error cargando el historial:', error);
            historyTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500 dark:text-red-400">Error al cargar el historial. Verifique la consola.</td></tr>`;
            noHistoryDiv.classList.add('hidden');
            showToast("Error al cargar el historial.", "error");
        }
    }

    // =============================
    // Renderiza la tabla de historial en la pestaña correspondiente
    // =============================
    function renderHistoryTable(verifications) {
        const historyTableBody = document.getElementById('history-table-body');
        const noHistoryDiv = document.getElementById('no-history');
        const historyCount = document.getElementById('history-count');

        if (!historyTableBody) {
            console.error('history table body not found in DOM');
            return;
        }
        historyTableBody.innerHTML = ''; // Clear previous content
        if (historyCount) historyCount.textContent = `${verifications.length} registro(s) encontrado(s)`;

        if (verifications.length === 0) {
            noHistoryDiv.classList.remove('hidden');
            return;
        }
        noHistoryDiv.classList.add('hidden');

        verifications.forEach(v => {
            const row = historyTableBody.insertRow(); // Use insertRow for better performance potentially
            row.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150';
            const statusIcon = v.status === 'ok'
                ? `<span class="px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full dark:bg-green-900 dark:text-green-300">OK</span>`
                : `<span class="px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full dark:bg-red-900 dark:text-red-300">Incidencia</span>`;

             // Safer innerHTML setting cell by cell
             row.insertCell().outerHTML = `<td class="px-4 py-3 whitespace-nowrap">${new Date(v.fecha).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' })}</td>`;
             row.insertCell().outerHTML = `<td class="px-4 py-3 font-medium">${v.sku}</td>`;
             row.insertCell().outerHTML = `<td class="px-4 py-3">${v.descripcion}</td>`;
             row.insertCell().outerHTML = `<td class="px-4 py-3 text-center">${statusIcon}</td>`;
             row.insertCell().outerHTML = `<td class="px-4 py-3">${v.inspector || '-'}</td>`;
             row.insertCell().outerHTML = `<td class="px-4 py-3">${v.turno || '-'}</td>`;
             row.insertCell().outerHTML = `<td class="px-4 py-3 text-center">${v.total_fotos > 0 ? `<i class="fas fa-camera text-sky-600 dark:text-sky-400"></i> ${v.total_fotos}` : '0'}</td>`;
             row.insertCell().outerHTML = `<td class="px-4 py-3 text-center">
                    <button class="view-details-btn text-sky-600 hover:underline text-sm" data-id="${v.id}" aria-label="Ver detalles de verificación ${v.id}">Detalles</button>
                </td>`;

        });
    }

    // =============================
    // Muestra los detalles de una verificación en el modal
    // =============================
    async function showVerificationDetails(verificationId) {
         const modalElement = document.getElementById('history-detail-modal');
         const backdropElement = document.getElementById('modal-backdrop');
         const modalContent = document.getElementById('history-modal-content');
         const modalInfo = document.getElementById('history-modal-info');
         if (!modalElement || !backdropElement || !modalContent || !modalInfo) {
             console.error('Modal elements for verification details are missing');
             showToast('No se pudo abrir el modal de detalles. Elemento no encontrado.', 'error');
             return;
         }
         modalContent.innerHTML = '<p class="text-center p-4">Cargando detalles... <i class="fas fa-spinner fa-spin"></i></p>'; // Loading state

        try {
            const transaction = db.transaction(['verificaciones', 'fotos'], 'readonly'); // Include fotos store
            const store = transaction.objectStore('verificaciones');
            const request = store.get(verificationId);

            request.onerror = (event) => {
                console.error("Error al obtener la verificación desde la base de datos:", event.target.error);
                showToast("No se pudo cargar la verificación desde la base de datos.", "error");
                modalContent.innerHTML = '<p class="text-center p-4 text-red-500 dark:text-red-400">Error al cargar detalles.</p>';
            };

            request.onsuccess = async () => {
                try {
                    const verification = request.result;
                    if (!verification) {
                        showToast('No se encontró la verificación.', "info");
                         modalContent.innerHTML = '<p class="text-center p-4">Verificación no encontrada.</p>';
                        return;
                    }

                    // Fetch photos within the same transaction if possible, or start a new one
                    const photos = await getPhotosForVerification(verificationId); // Assuming this function handles its own transaction

                    modalInfo.textContent = `SKU: ${verification.sku} | Fecha: ${new Date(verification.fecha).toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' })}`;

                    let checklistHtml = '<h4 class="text-md font-semibold mt-6 mb-3 border-t dark:border-gray-600 pt-4">Detalle de Checklist</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">';
                    parametrosChecklist.forEach(param => {
                        const status = verification.parametros ? verification.parametros[param.nombre] : null;
                        let icon = '<i class="fas fa-minus-circle text-gray-400 fa-fw mr-2" aria-hidden="true"></i>'; // Default to minus/unanswered
                        let textColor = 'text-gray-500 dark:text-gray-400';
                        if (status === 'si') {
                            icon = '<i class="fas fa-check-circle text-green-500 fa-fw mr-2" aria-hidden="true"></i>';
                            textColor = 'text-gray-800 dark:text-gray-200';
                        } else if (status === 'no') {
                            icon = '<i class="fas fa-times-circle text-red-500 fa-fw mr-2" aria-hidden="true"></i>';
                            textColor = 'font-semibold text-red-600 dark:text-red-400';
                        }
                        checklistHtml += `<div class="flex items-center ${textColor}">${icon}<span>${param.pregunta}</span></div>`;
                    });
                    checklistHtml += '</div>';

                    let qrHtml = '';
                    let generalNotes = verification.observaciones || 'Sin observaciones.';
                    const qrHeader = "Datos escaneados del QR:";
                     if (verification.observaciones && verification.observaciones.trim().startsWith(qrHeader)) {
                        const contentAfterHeader = verification.observaciones.substring(qrHeader.length).trim();
                         const lines = contentAfterHeader.split('\n').map(l => l.trim()).filter(l => l); // Trim and filter empty lines
                        const qrDataLines = [];
                        const otherNotesLines = [];
                        let parsingQR = true;

                        lines.forEach(line => {
                             if (line.startsWith('- ') && parsingQR) {
                                qrDataLines.push(line.substring(2).trim()); // Store only content after '- '
                            } else {
                                parsingQR = false; // Stop parsing QR data once a non-matching line is found
                                otherNotesLines.push(line);
                            }
                        });


                        if (qrDataLines.length > 0) {
                            qrHtml = '<h4 class="text-md font-semibold mt-6 mb-3 border-t dark:border-gray-600 pt-4">Información de Trazabilidad (QR)</h4><div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">';
                            qrDataLines.forEach(line => {
                                const parts = line.split(':');
                                if(parts.length >= 2) {
                                    const key = parts[0].trim();
                                    const value = parts.slice(1).join(':').trim();
                                    // Sanitize potential HTML in value
                                    const safeValue = value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                                    qrHtml += `<div><strong class="block text-gray-500 dark:text-gray-400">${key}:</strong><span>${safeValue}</span></div>`;
                                } else if (line) { // Handle lines without ':' as simple entries if needed
                                     //qrHtml += `<div><span>${line.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span></div>`;
                                }
                            });
                            qrHtml += '</div>';
                             // Join remaining lines for general notes
                             generalNotes = otherNotesLines.join('\n').trim() || 'No hay observaciones adicionales.';
                        } else {
                             // If parsing failed or no QR data lines found, treat all as general notes
                             generalNotes = verification.observaciones;
                        }
                    } else {
                         generalNotes = verification.observaciones || 'Sin observaciones.';
                    }
                     // Sanitize general notes before displaying
                     const safeGeneralNotes = generalNotes.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');


                    let photosHtml = '<h4 class="text-md font-semibold mt-6 mb-3 border-t dark:border-gray-600 pt-4">Fotos Adjuntas</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
                    if (photos && photos.length > 0) {
                        photos.forEach(photo => {
                            const param = parametrosChecklist.find(p => p.nombre === photo.parametro);
                            const altText = `Foto de ${param?.pregunta || 'evidencia'}`;
                            photosHtml += `
                                <div class="text-center">
                                    <a href="${photo.blob}" target="_blank" title="Ver imagen completa" class="block border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden hover:border-sky-500 transition">
                                        <img src="${photo.blob}" class="w-full h-32 object-cover" alt="${altText}">
                                    </a>
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">${param?.pregunta || 'Evidencia'}</p>
                                </div>`;
                        });
                    } else {
                        photosHtml += '<p class="col-span-full text-sm text-gray-500 dark:text-gray-400">No hay fotos para esta verificación.</p>';
                    }
                    photosHtml += '</div>';

                    const safeInspector = (verification.inspector || 'N/A').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const safeUbicacion = (verification.ubicacion || 'N/A').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    modalContent.innerHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-6">
                            <div><strong class="block text-gray-500 dark:text-gray-400">Inspector:</strong> ${safeInspector}</div>
                            <div><strong class="block text-gray-500 dark:text-gray-400">Turno:</strong> ${verification.turno || 'N/A'}</div>
                            <div><strong class="block text-gray-500 dark:text-gray-400">Ubicación:</strong> ${safeUbicacion}</div>
                            <div><strong class="block text-gray-500 dark:text-gray-400">Estado:</strong> ${verification.status === 'ok'
                                ? '<span class="font-semibold text-green-600 dark:text-green-400">OK</span>'
                                : '<span class="font-semibold text-red-600 dark:text-red-400">Con Incidencias</span>'}
                            </div>
                        </div>
                        ${checklistHtml}
                        ${qrHtml}
                        <div class="mt-6 border-t dark:border-gray-600 pt-4">
                            <h4 class="text-md font-semibold mb-2">Observaciones Generales</h4>
                            <p class="p-3 bg-gray-100 dark:bg-gray-700/50 rounded text-sm whitespace-pre-wrap">${safeGeneralNotes}</p> <!-- Use whitespace-pre-wrap -->
                        </div>
                        ${photosHtml}
                    `;

                    modalElement.classList.add('active');
                    backdropElement.classList.add('active');
                     // Focus management
                    try { modalElement.focus(); } catch (e) { /* ignore */ }
                    document.getElementById('close-history-modal')?.focus();


                } catch (error) {
                    console.error("Error al procesar los detalles de la verificación:", error);
                    showToast("No se pudieron procesar los detalles de la verificación.", "error");
                     modalContent.innerHTML = '<p class="text-center p-4 text-red-500 dark:text-red-400">Error al procesar detalles.</p>';
                }
            };
        } catch (error) {
            console.error("Error al configurar la solicitud de detalles:", error);
            showToast("No se pudieron cargar los detalles de la verificación.", "error");
             modalContent.innerHTML = '<p class="text-center p-4 text-red-500 dark:text-red-400">Error al iniciar la carga.</p>';
        }
    }


    let statsChart = null;
    // =============================
    // Carga y actualiza las estadísticas generales
    // =============================
    async function loadStatistics() {
        // Show loading states for stats elements (guarded)
        const statTotalEl = document.getElementById('stat-total');
        const statOkEl = document.getElementById('stat-ok');
        const statErrorEl = document.getElementById('stat-error');
        const statPhotosEl = document.getElementById('stat-photos');
        const topProductsEl = document.getElementById('top-products');
        const topInspectorsEl = document.getElementById('top-inspectors');
        if (statTotalEl) statTotalEl.textContent = '...';
        if (statOkEl) statOkEl.textContent = '...';
        if (statErrorEl) statErrorEl.textContent = '...';
        if (statPhotosEl) statPhotosEl.textContent = '...';
        if (topProductsEl) topProductsEl.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Cargando...</p>';
        if (topInspectorsEl) topInspectorsEl.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Cargando...</p>';


        try {
            // Use Promise.all to fetch data concurrently
            const [verifications, photos] = await Promise.all([
                 getAllFromStore('verificaciones'),
                 getAllFromStore('fotos')
            ]);

            // Update summary cards (guarded)
            if (statTotalEl) statTotalEl.textContent = verifications.length;
            const okCount = verifications.filter(v => v.status === 'ok').length;
            const errorCount = verifications.length - okCount;
            if (statOkEl) statOkEl.textContent = okCount;
            if (statErrorEl) statErrorEl.textContent = errorCount;
            if (statPhotosEl) statPhotosEl.textContent = photos.length;

            // Update chart and lists
            updateStatsChart({ ok: okCount, error: errorCount });
            updateTopProducts(verifications);
            updateTopInspectors(verifications);

       } catch (error) {
            console.error("Error al cargar estadísticas:", error);
            showToast("Error al cargar las estadísticas.", "error");
             // Show error state in stats elements
           if (statTotalEl) statTotalEl.textContent = 'Error';
           if (statOkEl) statOkEl.textContent = 'Error';
           if (statErrorEl) statErrorEl.textContent = 'Error';
           if (statPhotosEl) statPhotosEl.textContent = 'Error';
           if (topProductsEl) topProductsEl.innerHTML = '<p class="text-sm text-red-500 dark:text-red-400">Error al cargar.</p>';
           if (topInspectorsEl) topInspectorsEl.innerHTML = '<p class="text-sm text-red-500 dark:text-red-400">Error al cargar.</p>';
           if (statsChart) statsChart.destroy(); // Clear chart on error
        }
    }

    // =============================
    // Actualiza el gráfico de estadísticas
    // =============================
    function updateStatsChart(data) {
        const ctx = document.getElementById('stats-chart');
         if (!ctx) return; // Exit if canvas not found
         const context = ctx.getContext('2d');
        if (!context) return; // Exit if context cannot be obtained


        if (statsChart) {
            statsChart.destroy();
        }

         // Handle case with zero data to avoid Chart.js errors/warnings
        const total = data.ok + data.error;
        if (total === 0) {
             // Optionally display a message on the canvas or hide it
             context.clearRect(0, 0, ctx.width, ctx.height);
             context.textAlign = 'center';
             context.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-secondary') || '#888';
             context.fillText('No hay datos para mostrar', ctx.width / 2, ctx.height / 2);
             statsChart = null; // Ensure chart instance is cleared
             return;
        }


        statsChart = new Chart(context, {
            type: 'doughnut',
            data: {
                labels: ['OK', 'Con Incidencias'],
                datasets: [{
                    label: 'Estado', // Simpler label
                    data: [data.ok, data.error],
                    backgroundColor: [
                         getComputedStyle(document.documentElement).getPropertyValue('--color-green-text') || 'rgba(16, 185, 129, 0.7)', // Use CSS var if possible
                         getComputedStyle(document.documentElement).getPropertyValue('--color-red-text') || 'rgba(239, 68, 68, 0.7)'
                    ],
                    borderColor: [ // Use surface color for border for cutout effect
                         getComputedStyle(document.documentElement).getPropertyValue('--color-surface') || '#fff'
                    ],
                    borderWidth: 2 // Adjust border width as needed
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                 cutout: '60%', // Adjust for desired doughnut thickness
                plugins: {
                    legend: {
                         position: 'bottom', // Better placement for doughnut
                         labels: {
                             color: getComputedStyle(document.body).getPropertyValue('--color-text') || '#333', // Use CSS var for text color
                             boxWidth: 12,
                             padding: 15
                         }
                    },
                    tooltip: {
                         backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-surface') || '#fff',
                         titleColor: getComputedStyle(document.documentElement).getPropertyValue('--color-text') || '#333',
                         bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--color-text') || '#333',
                         borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-primary') || '#ccc',
                         borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                     // Calculate percentage
                                     const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                     const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%';
                                     label += `${context.parsed} (${percentage})`;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // =============================
    // Muestra los productos más verificados
    // =============================
    function updateTopProducts(verifications) {
        const productCounts = verifications.reduce((acc, v) => {
            acc[v.sku] = (acc[v.sku] || 0) + 1;
            return acc;
        }, {});
        const sortedProducts = Object.entries(productCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
    const container = document.getElementById('top-products');
    if (!container) return;
    container.innerHTML = ''; // Clear previous
        if (sortedProducts.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No hay datos suficientes.</p>';
            return;
        }
        sortedProducts.forEach(([sku, count]) => {
            const productInfo = productTemplates.find(p => p.sku === sku);
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center text-sm p-2 bg-gray-50 dark:bg-gray-700/50 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150';
            // Sanitize description
             const safeDescription = productInfo?.descripcion.replace(/</g, "&lt;").replace(/>/g, "&gt;") || 'Descripción no encontrada';
            div.innerHTML = `
                <div class="truncate mr-2">
                    <span class="font-semibold">${sku}</span>
                    <span class="text-gray-600 dark:text-gray-400 ml-2">${safeDescription}</span>
                </div>
                <span class="font-bold flex-shrink-0 px-2 py-0.5 rounded bg-sky-100 dark:bg-sky-900/50 text-sky-700 dark:text-sky-300">${count}</span>`;
            container.appendChild(div);
        });
    }

    // =============================
    // Muestra los inspectores más activos
    // =============================
    function updateTopInspectors(verifications) {
        const inspectorCounts = verifications.reduce((acc, v) => {
            if (v.inspector && v.inspector.trim()) {
                 const inspectorName = v.inspector.trim();
                 acc[inspectorName] = (acc[inspectorName] || 0) + 1;
             }
            return acc;
        }, {});
        const sortedInspectors = Object.entries(inspectorCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
    const container = document.getElementById('top-inspectors');
    if (!container) return;
    container.innerHTML = ''; // Clear previous
        if (sortedInspectors.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No hay datos suficientes.</p>';
            return;
        }
        sortedInspectors.forEach(([inspector, count]) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center text-sm p-2 bg-gray-50 dark:bg-gray-700/50 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150';
             // Sanitize inspector name
            const safeInspector = inspector.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            div.innerHTML = `<div class="truncate mr-2"><span class="font-semibold">${safeInspector}</span></div><span class="font-bold flex-shrink-0 px-2 py-0.5 rounded bg-sky-100 dark:bg-sky-900/50 text-sky-700 dark:text-sky-300">${count}</span>`;
            container.appendChild(div);
        });
    }

    // =============================
    // Carga la configuración de la aplicación
    // =============================
    function loadConfiguration() {
         try {
            const photoQualitySelect = document.getElementById('photo-quality');
            const photoMaxSizeSelect = document.getElementById('photo-max-size');

            if (!photoQualitySelect || !photoMaxSizeSelect) {
                console.warn('Configuration elements not found in DOM');
                return;
            }

            const savedQuality = localStorage.getItem('photoQuality');
            const savedSize = localStorage.getItem('photoMaxSize');

            if (savedQuality) photoQualitySelect.value = savedQuality;
            if (savedSize) photoMaxSizeSelect.value = savedSize;

            // <!-- [INICIO] MEJORA DE CÓDIGO -->
            // Se eliminaron los 'replaceWith' y 'addEventListener' de esta función.
            // Esta función ahora solo se encarga de *cargar y establecer los valores*.
            // La función initListeners() (al final del script) se encarga de
            // adjuntar *todos* los listeners de eventos una sola vez,
            // evitando duplicados o listeners perdidos.
            /*
            // CÓDIGO REDUNDANTE ELIMINADO:
            photoQualitySelect.replaceWith(photoQualitySelect.cloneNode(true));
            document.getElementById('photo-quality')?.addEventListener('change', (e) => {
                localStorage.setItem('photoQuality', e.target.value);
                showToast('Calidad de fotos guardada.', 'success');
            });
            photoMaxSizeSelect.replaceWith(photoMaxSizeSelect.cloneNode(true));
            document.getElementById('photo-max-size')?.addEventListener('change', (e) => {
                localStorage.setItem('photoMaxSize', e.target.value);
                showToast('Tamaño máximo de foto guardado.', 'success');
            });
            */
            // <!-- [FIN] MEJORA DE CÓDIGO -->


                updateStorageUsage();
                // Update diagnostic panel as configuration finished loading
                runDiagnostic().catch(() => {});
         } catch (error) {
             console.error("Error loading configuration:", error);
             showToast("Error al cargar la configuración.", "error");
         }
    }


    // =============================
    // Actualiza el uso de almacenamiento local
    // =============================
    async function updateStorageUsage() {
        const usageEl = document.getElementById('storage-usage');
        if (!usageEl) return;
        if (navigator.storage && navigator.storage.estimate) {
            try {
                const estimate = await navigator.storage.estimate();
                const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                const quotaMB = estimate.quota ? (estimate.quota / 1024 / 1024).toFixed(2) : 'N/A';
                usageEl.textContent = `${usedMB} MB / ${quotaMB} MB`;
            } catch (error) {
                console.warn("No se pudo estimar el uso de almacenamiento:", error);
                usageEl.textContent = 'No disponible';
            }
        } else {
            console.warn("API navigator.storage.estimate no disponible.");
            usageEl.textContent = 'No disponible';
        }
    }

    // Wire diagnostic refresh button (safely)
    try {
        document.getElementById('refresh-diagnostic-btn')?.addEventListener('click', () => {
            runDiagnostic().catch(err => console.error('Failed to run diagnostic', err));
        });
    } catch (e) {
        console.warn('Could not wire diagnostic button', e);
    }

    // =============================
    // Actualiza la fecha y hora en el encabezado
    // =============================
    function updateDateTime() {
        try {
            const now = new Date();
            const formattedDateTime = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + ' - ' + now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const element = document.getElementById('current-datetime');
            if (element) element.textContent = formattedDateTime;
        } catch (error) {
            console.error("Error updating date/time:", error);
            const element = document.getElementById('current-datetime');
            if (element) element.textContent = "Error al cargar fecha";
        }
    }
    updateDateTime();
    setInterval(updateDateTime, 30000); // Actualizar cada 30 segundos es suficiente

    const tableBody = document.getElementById('product-table-body');
    const noResultsDiv = document.getElementById('no-results');

    // =============================
    // Renderiza la tabla principal de productos
    // =============================
    function renderTable(data) {
        tableBody.innerHTML = ''; // Clear previous rows
        if (!data || data.length === 0) {
            noResultsDiv.classList.remove('hidden');
            return;
        }
        noResultsDiv.classList.add('hidden');

        const fragment = document.createDocumentFragment(); // Use fragment for performance
        data.forEach(product => {
            const row = document.createElement('tr');
            row.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150';
            row.dataset.sku = product.sku;
            let statusIcon = '';
             let statusText = 'Pendiente'; // For screen readers
            switch(product.status) {
                case 'ok':
                     statusIcon = `<i class="fas fa-check-circle text-green-500 fa-lg" aria-hidden="true"></i>`;
                     statusText = 'Verificado OK';
                     break;
                case 'error':
                     statusIcon = `<i class="fas fa-exclamation-triangle text-red-500 fa-lg" aria-hidden="true"></i>`;
                     statusText = 'Verificado con incidencias';
                     break;
                default:
                     statusIcon = `<i class="fas fa-circle text-gray-400 fa-sm" aria-hidden="true"></i>`;
            }
            // Sanitize description
            const safeDescription = product.descripcion.replace(/</g, "&lt;").replace(/>/g, "&gt;");

            row.innerHTML = `
                <td class="px-4 py-3 font-medium">${product.sku}</td>
                <td class="px-4 py-3">${safeDescription}</td>
                <td class="px-4 py-3 text-center font-bold text-lg">${product.factorEstiba}</td>
                <td class="px-4 py-3 text-center" title="${statusText}">${statusIcon}<span class="sr-only">${statusText}</span></td>
                <td class="px-4 py-3 text-center text-sm">${product.ubicacion || '-'}</td>
                <td class="px-4 py-3 text-center text-sm">${product.fotos_adjuntas > 0 ? `<i class="fas fa-camera text-sky-600 dark:text-sky-400"></i> ${product.fotos_adjuntas}` : '-'}</td>
                <td class="px-4 py-3 text-center">
                    <button class="check-btn px-3 py-1 bg-sky-600 text-white rounded-md hover:bg-sky-700 text-xs font-semibold" data-sku="${product.sku}" aria-label="Verificar producto ${product.sku}">Verificar</button>
                </td>`;
            fragment.appendChild(row);
        });
         tableBody.appendChild(fragment); // Append fragment once
    }


    const modal = document.getElementById('checklist-modal');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveBtn = document.getElementById('save-btn');
    const modalTitle = document.getElementById('checklist-modal-title');
    const modalSku = document.getElementById('modal-sku');
    const modalFactor = document.getElementById('modal-factor');
    const checklistForm = document.getElementById('checklist-form');
    const notesTextarea = document.getElementById('notes');
    const locationInput = document.getElementById('location');
    const gpsBtn = document.getElementById('gps-btn');
    let currentSku = null;

    // =============================
    // Renderiza los parámetros del checklist en el modal
    // =============================
    function renderParameters(product) {
        const container = document.getElementById('parametros-container');
        if (!container) return;
        container.innerHTML = ''; // Clear previous
        const fragment = document.createDocumentFragment(); // Use fragment

        parametrosChecklist.forEach((param) => {
            const paramDiv = document.createElement('div');
            paramDiv.className = 'border border-gray-200 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50';
            const currentValue = product.parametros[param.nombre] || '';
            const hasPhoto = product.fotos && product.fotos[param.nombre];
            paramDiv.innerHTML = `
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div class="flex-grow">
                        <h4 class="text-sm font-semibold mb-1" id="label-${param.nombre}">${param.id}. ${param.pregunta}</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${param.descripcion}</p>
                    </div>
                    <div class="flex items-center gap-4 mt-2 md:mt-0">
                        <fieldset class="flex gap-3" role="radiogroup" aria-labelledby="label-${param.nombre}">
                             <legend class="sr-only">${param.pregunta}</legend>
                             <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="${param.nombre}" value="si" ${currentValue === 'si' ? 'checked' : ''} class="text-green-500 focus:ring-green-500">
                                <span class="text-green-600 dark:text-green-400">Sí</span>
                             </label>
                             <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="${param.nombre}" value="no" ${currentValue === 'no' ? 'checked' : ''} class="text-red-500 focus:ring-red-500">
                                <span class="text-red-600 dark:text-red-400">No</span>
                             </label>
                        </fieldset>
                        <div class="flex flex-col items-center gap-1">
                            <input type="file" id="photo-${param.nombre}" accept="image/*" capture="environment" class="hidden" data-param="${param.nombre}" aria-labelledby="photo-label-${param.nombre}">
                            <label id="photo-label-${param.nombre}" class="sr-only">Agregar o cambiar foto para ${param.pregunta}</label>
                            <button type="button" class="photo-btn px-3 py-1 text-xs font-medium rounded-lg transition ${hasPhoto ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' : 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300'}" data-param="${param.nombre}">
                                <i class="fas fa-camera mr-1" aria-hidden="true"></i> ${hasPhoto ? 'Cambiar' : 'Agregar'}
                            </button>
                            <div class="photo-preview mt-1 h-8 w-8 bg-gray-200 dark:bg-gray-600 rounded overflow-hidden">
                                ${hasPhoto ? `<img src="${product.fotos[param.nombre]}" alt="Preview foto ${param.pregunta}" class="w-full h-full object-cover">` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            fragment.appendChild(paramDiv);
        });
         container.appendChild(fragment); // Append fragment once
    }


    // =============================
    // Abre el modal de verificación de producto
    // =============================
    function openModal(product) {
        if (!product) {
             console.error("Attempted to open modal with null product");
             showToast("Error: No se encontró el producto.", "error");
             return;
        }

        currentSku = product.sku;
    if (modalTitle) modalTitle.textContent = product.descripcion;
    if (modalSku) modalSku.textContent = `SKU: ${product.sku}`;
    if (modalFactor) modalFactor.textContent = product.factorEstiba;
        renderParameters(product); // Ensure this runs before accessing form elements
    const inspectorElLocal = document.getElementById('inspector');
    const turnoElLocal = document.getElementById('turno');
    if (inspectorElLocal) inspectorElLocal.value = product.inspector || '';
    if (turnoElLocal) turnoElLocal.value = product.turno || '';
    if (notesTextarea) notesTextarea.value = product.notes || '';
    if (locationInput) locationInput.value = product.ubicacion || '';
    modal?.classList.add('active');
    modalBackdrop?.classList.add('active');

        // Focus first interactive element for accessibility
        setTimeout(() => {
            const firstFocusable = modal.querySelector('input[type="radio"], input[type="text"], select, textarea, button:not([disabled])');
            if (firstFocusable) {
                 try { firstFocusable.focus(); } catch (e) { console.warn("Could not focus first element in modal"); }
             }
        }, 150); // Slightly longer delay for rendering
    }

    // =============================
    // Cierra el modal de verificación (y otros modales si es necesario)
    // =============================
    function closeModalAndBackdrop() {
         let anyModalActive = false;
         document.querySelectorAll('.modal.active').forEach(activeModal => {
             activeModal.classList.remove('active');
             // Special handling if needed (like stopping QR scanner)
             if (activeModal.id === 'qr-scanner-modal') {
                 stopQrScanner(true); // Pass flag to prevent backdrop double-hide
             }
         });
         modalBackdrop.classList.remove('active');
         currentSku = null; // Reset SKU when checklist modal closes
    }

    // Attach listener to backdrop to close any active modal
    modalBackdrop?.addEventListener('click', closeModalAndBackdrop);

    // Attach listeners specifically to close buttons
    closeModalBtn?.addEventListener('click', closeModalAndBackdrop);
    cancelBtn?.addEventListener('click', closeModalAndBackdrop);
    document.getElementById('close-history-modal')?.addEventListener('click', closeModalAndBackdrop);
    document.getElementById('close-qr-scanner-btn')?.addEventListener('click', closeModalAndBackdrop); // QR close button also uses the main function


    document.getElementById('parametros-container')?.addEventListener('change', (e) => {
        if (e.target.type === 'radio' && e.target.value === 'no') {
            const paramName = e.target.name;
            const product = products.find(p => p.sku === currentSku);
            if (product && (!product.fotos || !product.fotos[paramName])) {
                 const photoInput = document.getElementById(`photo-${paramName}`);
                 if (photoInput) photoInput.click();
            }
        }
    });

    document.addEventListener('click', (e) => {
        const checkBtn = e.target.closest('.check-btn');
        const photoBtn = e.target.closest('.photo-btn');
        if (checkBtn) {
            const product = products.find(p => p.sku === checkBtn.dataset.sku);
            if (product) openModal(product);
        }
       if (photoBtn) {
           const photoInput = document.getElementById(`photo-${photoBtn.dataset.param}`);
           if (photoInput) photoInput.click();
       }
    });

    document.addEventListener('change', async (e) => {
        if (e.target.type === 'file' && e.target.id.startsWith('photo-')) {
            const paramId = e.target.dataset.param;
            const file = e.target.files[0];
            const inputElement = e.target; // Keep reference to input

            if (file && currentSku) {
                const product = products.find(p => p.sku === currentSku);
                if (!product) return; // Should not happen if modal is open correctly
                if (!product.fotos) product.fotos = {};

                showLoader();
                try {
                    const maxSize = parseInt(document.getElementById('photo-max-size').value, 10);
                    const quality = parseFloat(document.getElementById('photo-quality').value);
                    const compressedBlob = await resizeImage(file, maxSize, quality);
                    const dataUrl = await blobToBase64(compressedBlob);
                    product.fotos[paramId] = dataUrl;

                    // Update UI (ensure elements exist)
                    const photoButton = document.querySelector(`button.photo-btn[data-param="${paramId}"]`);
                    const previewContainer = photoButton?.parentElement?.querySelector('.photo-preview');

                    if (photoButton) {
                        photoButton.innerHTML = `<i class="fas fa-camera mr-1"></i> Cambiar`;
                        photoButton.className = 'photo-btn px-3 py-1 text-xs font-medium rounded-lg transition bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300';
                    }
                    if (previewContainer) {
                        previewContainer.innerHTML = `<img src="${dataUrl}" alt="Preview ${paramId}" class="w-full h-full object-cover">`;
                    }

                    updatePhotoCount(product);
                    showToast('Foto agregada/actualizada.', 'success');
                } catch (error) {
                    console.error('Error processing photo:', error);
                    showToast(`Error al procesar la imagen: ${error.message}`, 'error');
                    // Optionally clear the failed photo data
                    // delete product.fotos[paramId];
                    // updatePhotoCount(product);
                    // Update UI to reflect failure (e.g., reset button/preview)
                } finally {
                    hideLoader();
                    if(inputElement) inputElement.value = null; // Reset file input
                }
            } else if (inputElement) {
                 inputElement.value = null; // Reset if no file selected or no SKU
            }
        }
    });


    // =============================
    // Actualiza el conteo de fotos adjuntas
    // =============================
    function updatePhotoCount(product) {
         if (product) { // Add check for product existence
            product.fotos_adjuntas = Object.keys(product.fotos || {}).length;
            // Optionally update the main table view if needed immediately
             const row = tableBody.querySelector(`tr[data-sku="${product.sku}"]`);
             if (row) {
                 const photoCell = row.cells[5]; // Assuming 6th cell is photos
                 if (photoCell) {
                      photoCell.innerHTML = product.fotos_adjuntas > 0 ? `<i class="fas fa-camera text-sky-600 dark:text-sky-400"></i> ${product.fotos_adjuntas}` : '-';
                 }
             }
        }
    }


    if (saveBtn) {
        saveBtn.addEventListener('click', () => {
        if (!currentSku) return;
        const product = products.find(p => p.sku === currentSku);
        if (!product) return;

        const formData = new FormData(checklistForm);
        let allAnswered = true;
        let firstUnansweredFieldset = null;

        parametrosChecklist.forEach(param => {
            if (!formData.has(param.nombre)) {
                allAnswered = false;
                 // Find the fieldset for visual feedback
                 const fieldset = checklistForm.querySelector(`input[name="${param.nombre}"]`)?.closest('fieldset');
                 if(fieldset && !firstUnansweredFieldset) {
                     firstUnansweredFieldset = fieldset; // Store the first one found
                 }
                 if(fieldset) { // Highlight all unanswered
                      fieldset.style.outline = '2px solid var(--cc-red)';
                      setTimeout(() => fieldset.style.outline = 'none', 3000);
                 }
            } else {
                 // Remove highlight if answered
                 const fieldset = checklistForm.querySelector(`input[name="${param.nombre}"]`)?.closest('fieldset');
                 if(fieldset) fieldset.style.outline = 'none';
            }
        });

        if (!allAnswered) {
            showToast('Por favor, responde "Sí" o "No" a todos los parámetros antes de guardar.', 'error');
             // Focus the first unanswered question
             if (firstUnansweredFieldset) {
                 const firstRadio = firstUnansweredFieldset.querySelector('input[type="radio"]');
                 if (firstRadio) firstRadio.focus();
             }
            return;
        }

        // Proceed with saving if all answered
        let hasError = false;
        parametrosChecklist.forEach(param => {
            const value = formData.get(param.nombre);
            product.parametros[param.nombre] = value;
            if (value === 'no') hasError = true;
        });
        product.status = hasError ? 'error' : 'ok';
        product.notes = notesTextarea.value;
        product.ubicacion = locationInput.value;
        product.inspector = document.getElementById('inspector').value;
        product.turno = document.getElementById('turno').value;
        updatePhotoCount(product); // Ensure count is updated before closing
        filterAndRender(); // Update main table view immediately
        closeModalAndBackdrop(); // Use combined close function
        showToast('Verificación guardada en la sesión actual.', 'success');
        });
    }


    if (gpsBtn) {
        gpsBtn.addEventListener('click', () => {
        if (!navigator.geolocation) return showToast('La geolocalización no es compatible con este navegador.', 'info');

        gpsBtn.disabled = true;
        gpsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> GPS';
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                locationInput.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                showToast('Ubicación GPS obtenida.', 'success');
            },
            (err) => {
                showToast(`Error GPS (${err.code}): ${err.message}`, 'error');
                console.error('GPS Error:', err);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
         // Always re-enable button after attempt (success or error handled above)
         setTimeout(() => {
             gpsBtn.disabled = false;
             gpsBtn.innerHTML = '<i class="fas fa-map-marker-alt mr-1"></i> GPS';
        }, 500); // Small delay to prevent rapid clicking
       });
    }


    const searchInput = document.getElementById('searchInput');
    if (!searchInput) {
        console.warn('Search input not found');
    }
    // =============================
    // Filtra y renderiza la tabla según el término de búsqueda
    // =============================
    function filterAndRender() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const filteredProducts = products.filter(p =>
             p.sku.toLowerCase().includes(searchTerm) ||
             p.descripcion.toLowerCase().includes(searchTerm)
        );
        renderTable(filteredProducts);
    }
    searchInput?.addEventListener('input', filterAndRender); // Use input for real-time filtering

    // =============================
    // Exporta los productos verificados a CSV
    // =============================
    function exportToCSV() {
        const verifiedProducts = products.filter(p => p.status !== 'pending');
        if (verifiedProducts.length === 0) {
            showToast('No hay productos verificados en la sesión actual para exportar.', 'info');
            return;
        }

         showLoader(); // Indicate processing
        try {
            const statusMap = { ok: 'OK', error: 'Con Incidencias' };
            let csvContent = "\uFEFF"; // BOM for Excel compatibility with UTF-8
            const headers = ["SKU", "Descripción", "Factor Estiba", "Estado General", "Inspector", "Turno", "Ubicación", "Observaciones Generales", ...parametrosChecklist.map(p => p.pregunta)];
            csvContent += headers.map(h => `"${h.replace(/"/g, '""')}"`).join(",") + "\r\n";
            verifiedProducts.forEach(product => {
                const row = [
                    product.sku, product.descripcion, product.factorEstiba,
                    statusMap[product.status] || product.status,
                    product.inspector || '', product.turno || '', product.ubicacion || '', product.notes || '',
                    ...parametrosChecklist.map(p => product.parametros[p.nombre] || '')
                ];
                 csvContent += row.map(field => `"${String(field == null ? '' : field).replace(/"/g, '""')}"`).join(",") + "\r\n";
            });

             const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
             const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `checklist_export_${new Date().toISOString().slice(0,10)}.csv`);
             link.style.visibility = 'hidden'; // Hide the link
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
             URL.revokeObjectURL(url); // Clean up blob URL
             showToast('Exportación CSV iniciada.', 'success');
         } catch (error) {
             console.error("Error exporting session CSV:", error);
             showToast("Error al generar el archivo CSV.", "error");
         } finally {
             hideLoader(); // Stop indicating processing
         }
    }


    // =============================
    // Imprime el reporte de productos verificados
    // =============================
    function printReport() {
        const verifiedProducts = products.filter(p => p.status !== 'pending');
        if (verifiedProducts.length === 0) {
            showToast('No hay productos verificados para imprimir.', 'info');
            return;
        }

         // Show loader while preparing print data
         showLoader();

        try {
            const statusMap = { ok: 'OK', error: 'Con Incidencias' };
            const now = new Date();
            const currentDate = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const currentTime = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const emissionDate = now.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            const expirationDate = new Date(now.getFullYear() + 3, 11).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            const documentCode = `CKLST-${now.getFullYear().toString().slice(-2)}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;

            // Parameter Summary
            const parameterSummary = parametrosChecklist.map(param => {
                const total = verifiedProducts.length;
                const compliant = verifiedProducts.filter(p => p.parametros[param.nombre] === 'si').length;
                const percentage = total > 0 ? ((compliant / total) * 100).toFixed(1) : '0.0';
                return { parameter: param.pregunta, compliant, nonCompliant: total - compliant, percentage };
            });
            const summaryRows = parameterSummary.map(item => `
                <tr>
                    <td style="border:1px solid #ccc; padding:4px;">${item.parameter}</td>
                    <td style="border:1px solid #ccc; padding:4px; text-align: center;">${item.compliant}</td>
                    <td style="border:1px solid #ccc; padding:4px; text-align: center;">${item.nonCompliant}</td>
                    <td style="border:1px solid #ccc; padding:4px; text-align: center; font-weight: bold; color: ${item.percentage >= 95 ? '#166534' : item.percentage >= 80 ? '#d97706' : '#dc2626'};">${item.percentage}%</td>
                </tr>`).join('');

            // Compute summary variables used in header (was missing)
            const totalProducts = verifiedProducts.length;
            const okProducts = verifiedProducts.filter(p => p.status === 'ok').length;
            const errorProducts = totalProducts - okProducts;
            const overallCompliance = totalProducts > 0 ? ((okProducts / totalProducts) * 100).toFixed(1) : '0.0';

            // Detailed Product Table
             const tableRowsPromises = verifiedProducts.map(async p => { // Make async to handle potential photo loading if needed later
                 const compliantCount = parametrosChecklist.filter(param => p.parametros[param.nombre] === 'si').length;
                 const compliancePercentage = ((compliantCount / parametrosChecklist.length) * 100).toFixed(1);

                let productRow = `
                <tr style="page-break-inside: avoid;">
                    <td style="border:1px solid #ccc; padding:4px;">${p.sku}</td>
                    <td style="border:1px solid #ccc; padding:4px;">${p.descripcion.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</td>
                    <td style="border:1px solid #ccc; padding:4px; text-align: center;">${p.factorEstiba}</td>
                    <td style="border:1px solid #ccc; padding:4px; text-align: center; font-weight: bold; color: ${p.status === 'ok' ? '#166534' : '#dc2626'};">${statusMap[p.status]}</td>
                    <td style="border:1px solid #ccc; padding:4px; text-align: center;">${compliancePercentage}%</td>
                    <td style="border:1px solid #ccc; padding:4px;">${(p.ubicacion || '-').replace(/</g, "&lt;").replace(/>/g, "&gt;")}</td>
                    <td style="border:1px solid #ccc; padding:4px;">${(p.inspector || '-').replace(/</g, "&lt;").replace(/>/g, "&gt;")}</td>
                    <td style="border:1px solid #ccc; padding:4px;">${p.turno || '-'}</td>
                    <td style="border:1px solid #ccc; padding:4px; text-align: center;">${p.fotos_adjuntas || 0}</td>
                </tr>`;

                if (p.fotos_adjuntas > 0 && p.fotos) {
                    const photoItems = Object.entries(p.fotos).map(([parametroId, fotoData]) => {
                        const paramInfo = parametrosChecklist.find(param => param.nombre === parametroId);
                        const paramQuestion = paramInfo ? paramInfo.pregunta.replace(/[¿?]/g, '') : parametroId;
                        return `
                            <div class="photo-item" style="display:inline-block; margin:5px; text-align:center; font-size:9px; color:#555; vertical-align: top; width: 120px;">
                                <img src="${fotoData}" alt="${paramQuestion.replace(/"/g, '&quot;')}" style="max-width:120px; max-height:120px; border:1px solid #ddd; border-radius:4px; margin-bottom:3px; object-fit: contain;">
                                <p style="margin:0; word-wrap: break-word;">${paramQuestion}</p>
                            </div>
                        `;
                    }).join('');

                    productRow += `
                        <tr class="photo-row" style="page-break-inside: avoid;">
                            <td colspan="9" style="border:1px solid #ccc; padding: 10px; background-color: #fdfdfd;">
                                <div class="photo-container">${photoItems}</div>
                            </td>
                        </tr>
                    `;
                }
                return productRow;
             });

             // Resolve all row promises
             Promise.all(tableRowsPromises).then(resolvedTableRows => {
                 const tableRows = resolvedTableRows.join('');

                const printWindow = window.open('', '_blank');
                 if (!printWindow) {
                     showToast("No se pudo abrir la ventana de impresión. Verifique bloqueadores de pop-ups.", "error");
                     hideLoader();
                     return;
                 }
                printWindow.document.write(`<html><head><title>Reporte de Verticalidad y Estibado</title><style>
                    body { font-family: Arial, sans-serif; color: #333; margin: 15px; font-size: 10pt; line-height: 1.3; }
                    .page-break { page-break-after: always; }
                    table { page-break-inside: avoid; width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; vertical-align: top; word-wrap: break-word; }
                    th { background-color: #f2f2f2; font-weight: bold; }
                    h1 { font-size: 16pt; } h2 { font-size: 13pt; } h3 { font-size: 11pt; color: #555; font-weight: normal; margin: 5px 0;}
                    .header-table td { border: 1px solid #222; padding: 6px; text-align: center; vertical-align: middle; font-size: 10pt; }
                    .section-title { background-color: #e3f2fd; padding: 6px; font-weight: bold; margin: 20px 0 8px; border-left: 3px solid #1976d2; font-size: 11pt; }
                    .summary-stats { background-color: #f8f9fa; padding: 10px; border-left: 3px solid #28a745; margin-bottom: 15px; font-size: 10pt; }
                    .photo-container { /* Style as needed */ }
                    .photo-item img { max-width:100px; max-height:100px; border:1px solid #ddd; border-radius:4px; margin-bottom:3px; object-fit: contain; }
                    @media print { body { -webkit-print-color-adjust: exact; color-adjust: exact; margin: 10mm; } }
                </style></head><body>`);

                // --- HEADER ---
                printWindow.document.write(`
                    <table class="header-table">
                    <tr>
                        <td style="width:20%;"><div style="font-weight:bold; font-size: 14pt; color: #ed1c24;">Coca-Cola FEMSA</div></td>
                        <td style="width:60%;">
                        <div style="font-weight:bold;font-size:11pt;">Confiabilidad de la información</div>
                        <div style="font-weight:bold;font-size:12pt;">Reporte de Devoluciones Planta</div>
                        </td>
                        <td style="width:20%; font-size: 9pt;">Dirección Cadena de Suministro<br><span style="font-weight:normal;">Coca-Cola FEMSA</span></td>
                    </tr>
                    <tr>
                        <td><strong>Fecha Emisión:</strong><br>${emissionDate}</td>
                        <td><strong>Fecha Expiración:</strong><br>${expirationDate}</td>
                        <td><strong>Código:</strong><br>${documentCode}<br><strong>Revisión:</strong> Rev 04</td>
                    </tr>
                    </table>`);

                printWindow.document.write(`<div style="text-align:center;margin-bottom:15px;">
                    <h1>Checklist de Verticalidad y Estibado</h1>
                    <h2>Planta "Cuautitlán"</h2>
                    <h3>Generado el ${currentDate} a las ${currentTime}</h3>
                    <div class="summary-stats"><strong>Resumen:</strong> ${totalProducts} verificados | ${okProducts} OK (${overallCompliance}%) | ${errorProducts} Incidencias (${(100 - parseFloat(overallCompliance)).toFixed(1)}%)</div>
                </div>`);

                // --- PAGE 1: PARAMETER SUMMARY ---
                printWindow.document.write(`
                    <div class="section-title">Resumen de Cumplimiento por Parámetro</div>
                    <table><thead><tr><th>Parámetro</th><th>OK</th><th>No OK</th><th>% OK</th></tr></thead><tbody>${summaryRows}</tbody></table>`);

                printWindow.document.write('<div class="page-break"></div>');

                // --- PAGE 2: DETAILED REPORT ---
                printWindow.document.write(`
                    <div class="section-title">Detalle de Productos Verificados</div>
                    <table><thead><tr><th>SKU</th><th>Desc.</th><th>Factor</th><th>Estado</th><th>% OK</th><th>Ubic.</th><th>Insp.</th><th>Turno</th><th>Fotos</th></tr></thead><tbody>${tableRows}</tbody></table>`);

                printWindow.document.write('</body></html>');
                printWindow.document.close();

                 // Delay print slightly
                 setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    hideLoader(); // Hide loader after print dialog opens
                    // printWindow.close(); // Consider closing after print
                }, 750); // Increased delay slightly more

             }).catch(rowError => {
                  console.error("Error generating print rows:", rowError);
                  showToast("Error al generar las filas del reporte.", "error");
                  hideLoader();
             });

         } catch (error) {
            console.error("Error preparing print:", error);
            showToast("Error al preparar la impresión.", "error");
            hideLoader();
        }
    }


    // =============================
    // Exporta el historial filtrado a CSV
    // =============================
    async function exportHistory() {
        showLoader();
        try {
            const filters = {
                dateFrom: document.getElementById('filter-date-from').value,
                dateTo: document.getElementById('filter-date-to').value,
                sku: document.getElementById('filter-sku').value.toLowerCase().trim(),
                inspector: document.getElementById('filter-inspector').value.toLowerCase().trim(),
                status: document.getElementById('filter-status').value
            };
            let verifications = await getAllFromStore('verificaciones');

             // Filter logic
             verifications = verifications.filter(v => {
                 const fechaVerificacion = v.fecha.split('T')[0];
                 if (filters.dateFrom && fechaVerificacion < filters.dateFrom) return false;
                 if (filters.dateTo && fechaVerificacion > filters.dateTo) return false;
                 if (filters.sku && !v.sku.toLowerCase().includes(filters.sku)) return false;
                 if (filters.inspector && !(v.inspector && v.inspector.toLowerCase().includes(filters.inspector))) return false;
                 if (filters.status && v.status !== filters.status) return false;
                 return true;
            });


            if (verifications.length === 0) {
                showToast('No hay registros en el historial que coincidan con los filtros.', 'info');
                return; // Return instead of alert
            }

            const statusMap = { ok: 'OK', error: 'Con Incidencias' };
            let csvContent = "\uFEFF"; // BOM for Excel
            const headers = ["Fecha", "SKU", "Descripción", "Estado General", "Inspector", "Turno", "Ubicación", "Observaciones", "Fotos Adjuntas", ...parametrosChecklist.map(p => p.pregunta)];
            csvContent += headers.map(h => `"${h.replace(/"/g, '""')}"`).join(",") + "\r\n";
            verifications.forEach(v => {
                const row = [
                     new Date(v.fecha).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' }), // Format date/time
                     v.sku, v.descripcion,
                     statusMap[v.status] || v.status,
                     v.inspector || '', v.turno || '', v.ubicacion || '',
                     (v.observaciones || '').replace(/\n/g, ' '), // Replace newlines in notes
                     v.total_fotos || 0,
                     ...parametrosChecklist.map(p => v.parametros[p.nombre] || '') // Ensure empty string if parameter missing
                 ];
                csvContent += row.map(field => `"${String(field == null ? '' : field).replace(/"/g, '""')}"`).join(",") + "\r\n";
            });

             const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
             const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `historial_export_${new Date().toISOString().slice(0,10)}.csv`);
             link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
             URL.revokeObjectURL(url);
            showToast('Exportación de historial iniciada.', 'success');
        } catch (error) {
            console.error("Error al exportar el historial:", error);
            showToast("Ocurrió un error al exportar el historial.", "error");
        } finally {
             hideLoader();
        }
    }


    // =============================
    // Exporta toda la base de datos a JSON
    // =============================
    async function exportAllData() {
        const confirmed = await showConfirmation("Exportar Base de Datos", "Esto exportará toda la base de datos como un archivo JSON. Puede tardar unos momentos. ¿Desea continuar?");
        if (!confirmed) return;

        showLoader();
        try {
             // Fetch data concurrently
             const [verificationsData, fotosData] = await Promise.all([
                 getAllFromStore('verificaciones'),
                 getAllFromStore('fotos')
            ]);

            const dataToExport = {
                verifications: verificationsData,
                fotos: fotosData, // Include photos
                exportDate: new Date().toISOString()
            };
            const dataStr = JSON.stringify(dataToExport); // No pretty print for potentially large data
            const dataBlob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `checklist_db_backup_${new Date().toISOString().slice(0,10)}.json`);
             link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Exportación completa de la base de datos iniciada.', 'success');
        } catch (error) {
            console.error("Error al exportar toda la base de datos:", error);
            showToast("Ocurrió un error al exportar la base de datos.", "error");
        } finally {
             hideLoader();
        }
    }


    // =============================
    // Elimina verificaciones y fotos de más de 6 meses
    // =============================
    async function cleanOldData() {
        const confirmed = await showConfirmation("Limpiar Datos Antiguos", "Esto eliminará permanentemente todas las verificaciones y fotos de más de 6 meses. ¿Está seguro?");
        if (!confirmed) return;

        showLoader();
        let deletedCount = 0;
        let photoDeleteCount = 0; // Track deleted photos too

        try {
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

            const transaction = db.transaction(['verificaciones', 'fotos'], 'readwrite');
            const verificationsStore = transaction.objectStore('verificaciones');
            const fotosStore = transaction.objectStore('fotos');
            const fotosIndex = fotosStore.index('verificacion_id');

             const verificationKeysToDelete = [];
             // First pass: find keys of old verifications
             let cursorReq = verificationsStore.openCursor();
             await new Promise((resolve, reject) => {
                 cursorReq.onsuccess = event => {
                     const cursor = event.target.result;
                     if (cursor) {
                         if (new Date(cursor.value.fecha) < sixMonthsAgo) {
                             verificationKeysToDelete.push(cursor.primaryKey);
                         }
                         cursor.continue();
                     } else {
                         resolve(); // Cursor finished
                     }
                 };
                 cursorReq.onerror = event => reject(event.target.error);
             });

            // Second pass: delete verifications and their photos
            for (const key of verificationKeysToDelete) {
                 // Delete photos first
                 let photoCursorReq = fotosIndex.openCursor(IDBKeyRange.only(key));
                 await new Promise((resolvePhoto, rejectPhoto) => {
                     photoCursorReq.onsuccess = event => {
                         const photoCursor = event.target.result;
                         if (photoCursor) {
                              photoCursor.delete(); // Delete photo
                              photoDeleteCount++;
                             photoCursor.continue();
                         } else {
                             resolvePhoto(); // Finished deleting photos for this verification
                         }
                     };
                     photoCursorReq.onerror = event => rejectPhoto(event.target.error);
                 });

                 // Then delete the verification
                 await new Promise((resolveVerification, rejectVerification) => {
                     const deleteReq = verificationsStore.delete(key);
                     deleteReq.onsuccess = () => {
                         deletedCount++;
                         resolveVerification();
                     };
                     deleteReq.onerror = event => rejectVerification(event.target.error);
                 });
            }

             // Wait for transaction to complete
            await transaction.done;

            showToast(`${deletedCount} registro(s) antiguo(s) y ${photoDeleteCount} foto(s) eliminados.`, 'success');

             // Refresh relevant views
            if (document.querySelector('.tab-button[data-tab="historial"]').classList.contains('active')) loadHistoryContent();
            if (document.querySelector('.tab-button[data-tab="estadisticas"]').classList.contains('active')) loadStatistics();
            if (document.querySelector('.tab-button[data-tab="configuracion"]').classList.contains('active')) updateStorageUsage();

        } catch (error) {
            console.error("Error al limpiar datos antiguos:", error);
            showToast(`Ocurrió un error al limpiar los datos: ${error.message}`, "error");
        } finally {
            hideLoader();
        }
    }


    // =============================
    // Elimina todos los datos de la base de datos
    // =============================
    async function clearAllData() {
        const confirmed = await showConfirmation("¡ADVERTENCIA!", "Esto borrará TODAS las verificaciones y fotos permanentemente. Esta acción no se puede deshacer. ¿Está absolutamente seguro?");
        if (!confirmed) return;

        showLoader();
        try {
            const transaction = db.transaction(['verificaciones', 'fotos'], 'readwrite');
            const verificationsStore = transaction.objectStore('verificaciones');
            const fotosStore = transaction.objectStore('fotos');

             // Use Promise.all for concurrent clearing
            await Promise.all([
                 new Promise((res, rej) => { const req = verificationsStore.clear(); req.onsuccess = res; req.onerror = rej; }),
                 new Promise((res, rej) => { const req = fotosStore.clear(); req.onsuccess = res; req.onerror = rej; })
            ]);

             // Wait for transaction to complete (implicit commit on success)
            await transaction.done;

            showToast("Todos los datos han sido eliminados.", "info");
            products = productTemplates.map(createInitialProductState); // Reset session state
            renderTable(products); // Re-render main table

             // Refresh other views
            if (document.querySelector('.tab-button[data-tab="historial"]').classList.contains('active')) loadHistoryContent();
            if (document.querySelector('.tab-button[data-tab="estadisticas"]').classList.contains('active')) loadStatistics();
            if (document.querySelector('.tab-button[data-tab="configuracion"]').classList.contains('active')) updateStorageUsage();

        } catch (error) {
            console.error("Error al limpiar la base de datos:", error);
            showToast(`Ocurrió un error al limpiar la base de datos: ${error.message}`, "error");
        } finally {
            hideLoader();
        }
    }


    const exportBtnEl = document.getElementById('export-btn');
    if (exportBtnEl) { exportBtnEl.addEventListener('click', exportToCSV); console.log('export-btn listener attached'); }
    const printBtnEl = document.getElementById('print-btn');
    if (printBtnEl) { printBtnEl.addEventListener('click', printReport); console.log('print-btn listener attached'); }

    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
         // Add keydown listener for accessibility (Enter/Space)
         button.addEventListener('keydown', (e) => {
             if (e.key === 'Enter' || e.key === ' ') {
                 e.preventDefault(); // Prevent default space scroll
                 switchTab(e.currentTarget.dataset.tab);
             }
         });
    });

    const applyFiltersBtn = document.getElementById('apply-filters');
    if (applyFiltersBtn) { applyFiltersBtn.addEventListener('click', loadHistoryContent); }
    const exportHistoryBtn = document.getElementById('export-history');
    if (exportHistoryBtn) { exportHistoryBtn.addEventListener('click', exportHistory); }
    const exportAllBtn = document.getElementById('export-all-data');
    if (exportAllBtn) { exportAllBtn.addEventListener('click', exportAllData); }
    const cleanOldBtn = document.getElementById('clean-old-data');
    if (cleanOldBtn) { cleanOldBtn.addEventListener('click', cleanOldData); }
    const clearAllBtn = document.getElementById('clear-all-data');
    if (clearAllBtn) { clearAllBtn.addEventListener('click', clearAllData); }

    // Use event delegation for dynamically added history buttons
    const historyTableBodyEl = document.getElementById('history-table-body');
    if (historyTableBodyEl) {
        historyTableBodyEl.addEventListener('click', (e) => {
        const viewBtn = e.target.closest('.view-details-btn');
        if (viewBtn && viewBtn.dataset.id) {
             try {
                showVerificationDetails(parseInt(viewBtn.dataset.id, 10));
             } catch (error) {
                 console.error("Error parsing verification ID for details:", error);
                 showToast("ID de verificación inválido.", "error");
             }
        }
        // Add delete button handler here if needed in the future
        // const deleteBtn = e.target.closest('.delete-verification-btn');
        // if (deleteBtn) { ... }
        });
    }


    // ===== NEW ATOMIC SAVE FUNCTION =====
    // =============================
    // Guarda la sesión actual en el historial (IndexedDB)
    // =============================
    async function commitSessionToHistory() {
        const productsToCommit = products.filter(p => p.status !== 'pending');
        if (productsToCommit.length === 0) {
            showToast('No hay verificaciones completadas para guardar.', 'info');
            return;
        }

        if (!db) {
            showToast('Error: La base de datos no está disponible. No se puede guardar.', 'error');
            return;
        }

        showLoader();
        const btn = document.getElementById('commit-session-btn');
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...`;

        const transaction = db.transaction(['verificaciones', 'fotos'], 'readwrite');
        const verificacionesStore = transaction.objectStore('verificaciones');
        const fotosStore = transaction.objectStore('fotos');
        let commitError = null;

        try {
            const promises = productsToCommit.map(product => {
                return new Promise(async (resolve, reject) => { // Mark inner promise as async
                    try {
                        const verification = {
                            sku: product.sku, descripcion: product.descripcion, factorEstiba: product.factorEstiba,
                            status: product.status, fecha: new Date().toISOString(), inspector: product.inspector,
                            turno: product.turno, ubicacion: product.ubicacion, observaciones: product.notes,
                            parametros: product.parametros, total_fotos: product.fotos_adjuntas
                        };

                        const verificationId = await new Promise((res, rej) => { // await adding verification
                            const request = verificacionesStore.add(verification);
                            request.onsuccess = () => res(request.result);
                            request.onerror = (e) => rej(e.target.error);
                        });

                        // Add photos for this verification
                        let photoAddPromises = [];
                        if (product.fotos && Object.keys(product.fotos).length > 0) {
                            for (const [parametroId, fotoData] of Object.entries(product.fotos)) {
                                photoAddPromises.push(new Promise((resPhoto, rejPhoto) => {
                                    const photoReq = fotosStore.add({
                                        verificacion_id: verificationId,
                                        parametro: parametroId,
                                        blob: fotoData,
                                        fecha: verification.fecha
                                    });
                                    photoReq.onsuccess = resPhoto;
                                    photoReq.onerror = (e) => rejPhoto(e.target.error);
                                }));
                            }
                        }
                        await Promise.all(photoAddPromises); // await adding photos
                        resolve(); // Resolve outer promise after verification and photos are added
                    } catch (innerError) {
                        reject(innerError); // Propagate error
                    }
                });
            });

            await Promise.all(promises); // Wait for all products and their photos

        } catch (error) {
            commitError = error;
            console.error("Error durante la preparación/guardado:", error);
             if (transaction.error === null && transaction.readyState === 'active') { // Abort only if active and no underlying error already aborted it
                try { transaction.abort(); } catch (abortError) { console.warn("Error aborting transaction:", abortError); }
            }
        }

        transaction.oncomplete = () => {
            if (commitError) return; // Prevent success message if error occurred
            hideLoader();
            showToast(`✅ ${productsToCommit.length} verificaciones guardadas con éxito.`, 'success');
            // Reset products state
            productsToCommit.forEach(p => {
                const template = productTemplates.find(t => t.sku === p.sku);
                if (template) {
                    Object.assign(p, createInitialProductState(template));
                }
            });
            filterAndRender();
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-save mr-2"></i> Guardar en Historial`;
        };

        transaction.onerror = (event) => {
            hideLoader();
            // Error might be from commit phase or caught earlier
             const finalError = event.target.error || commitError;
            console.error('Error en la transacción de guardado:', finalError);
            showToast(`⚠️ Error grave al guardar: ${finalError?.message || 'Error desconocido'}`, 'error');
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-save mr-2"></i> Guardar en Historial`;
        };
    }


    const commitSessionBtn = document.getElementById('commit-session-btn');
    if (commitSessionBtn) { commitSessionBtn.addEventListener('click', commitSessionToHistory); }

    // =============================
    // Lógica del escáner QR
    // =============================
    const qrScannerModal = document.getElementById('qr-scanner-modal');
    const scanQrMainBtn = document.getElementById('scan-qr-main-btn');
    if (scanQrMainBtn) { scanQrMainBtn.addEventListener('click', startQrScanner); }
    // closeQrScannerBtn is handled by closeModalAndBackdrop
    const qrResultEl = document.getElementById('qr-result');

    const onScanSuccess = (decodedText, decodedResult) => {
        qrResultEl.textContent = `Escaneo exitoso! Procesando...`;
        stopQrScanner(true); // Stop camera, keep backdrop if opening checklist modal

        try {
            const lines = decodedText.split(/[\r\n]+/).map(l => l.trim()).filter(l => l); // Clean lines
            const qrData = {};
            let skuFromQR = null;

            lines.forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parts.slice(1).join(':').trim();
                    qrData[key] = value;
                    if (key.toUpperCase() === 'SKU') {
                         let potentialSKU = value.replace(/\D/g, ''); // Remove non-digits
                         const matchedTemplate = productTemplates.find(t => t.sku === potentialSKU);
                         if (matchedTemplate) skuFromQR = matchedTemplate.sku; // Use exact match from template
                    }
                }
            });

            if (!skuFromQR) {
                showToast('Código QR no contiene un SKU reconocible.', 'info');
                 closeModalAndBackdrop(); // Close QR modal and backdrop fully
                return;
            }

            const product = products.find(p => p.sku === skuFromQR);
            if (!product) {
                showToast(`Producto con SKU ${skuFromQR} no encontrado en la lista actual.`, 'error');
                 closeModalAndBackdrop(); // Close QR modal and backdrop fully
                return;
            }

            let traceabilityNotes = "Datos escaneados del QR:\n";
            for (const [key, value] of Object.entries(qrData)) {
                if (key.toUpperCase() !== 'SKU') {
                     // Basic sanitization
                    const safeValue = String(value).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    traceabilityNotes += `- ${key}: ${safeValue}\n`;
                }
            }

            openModal(product); // Open checklist modal (backdrop remains)

            // Populate notes after modal is potentially rendered
            setTimeout(() => {
                const notesArea = document.getElementById('notes');
                if(notesArea) {
                     // Prepend QR data to existing notes if any
                     notesArea.value = traceabilityNotes + (product.notes || '');
                }
                showToast('Datos QR cargados en observaciones.', 'success');
            }, 150);

         } catch (error) {
             console.error("Error processing QR code:", error);
             showToast("Error al procesar el código QR.", "error");
             closeModalAndBackdrop(); // Ensure backdrop closes on error
         }
    };


    const onScanFailure = (error) => {
        // console.warn(`QR scan error: ${error}`); // Optional: Log errors for debugging
         // Provide subtle feedback if desired, e.g., brief border flash
         const readerEl = document.getElementById('qr-reader');
         if (readerEl && !qrResultEl.textContent.includes('Error')) { // Avoid spamming on init error
             readerEl.style.outline = '2px solid red';
             setTimeout(() => { if(readerEl) readerEl.style.outline = 'none'; }, 300);
         }
    };

    // =============================
    // Inicia el escáner QR
    // =============================
    function startQrScanner() {
        if (html5QrCode) { // If already running, do nothing or stop first
            console.warn("Scanner already potentially running or failed to stop previously.");
             // Attempt to stop just in case
             stopQrScanner(true).then(() => {
                 console.log("Forcing stop before restart.");
                 startQrScannerInternal(); // Try starting again after stopping
             });
             return;
        }
         startQrScannerInternal(); // Normal start
    }

     function startQrScannerInternal() {
         qrScannerModal.classList.add('active');
         modalBackdrop.classList.add('active');
         qrResultEl.textContent = 'Apunte la cámara al código QR';
         qrResultEl.classList.remove('text-red-500'); // Reset error color

        const qrReaderEl = document.getElementById('qr-reader');
        if (qrReaderEl) {
            qrReaderEl.style.height = qrReaderEl.offsetHeight > 50 ? `${qrReaderEl.offsetHeight}px` : '360px'; // Maintain height or default
             qrReaderEl.style.outline = 'none'; // Reset error outline
        }

        setTimeout(() => {
            try {
                if(html5QrCode) { // Double check if it became non-null unexpectedly
                     console.warn("html5QrCode instance detected before new creation.");
                     return; // Avoid creating multiple instances
                }
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 }, supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA] };
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .then(() => {
                         console.log("QR Scanner started successfully.");
                         // Focus the close button for accessibility
                         document.getElementById('close-qr-scanner-btn')?.focus();
                    })
                    .catch(err => {
                        console.error("No se pudo iniciar el escáner QR", err);
                        qrResultEl.textContent = `Error cámara: ${err.message || err}`;
                         qrResultEl.classList.add('text-red-500'); // Add error color
                        showToast('Error al iniciar la cámara. Verifique permisos.', 'error');
                        // Clean up instance if start fails
                        if (html5QrCode) {
                             try { html5QrCode.stop().catch(()=>{}); } catch(e){}
                             html5QrCode = null;
                        }
                        // Optionally close modal on start failure after a delay
                        // setTimeout(closeModalAndBackdrop, 1500);
                    });
            } catch (err) {
                console.error('Error inicializando Html5Qrcode:', err);
                qrResultEl.textContent = 'Error al inicializar el escáner.';
                qrResultEl.classList.add('text-red-500');
                showToast('Error al inicializar el escáner.', 'error');
                 if (html5QrCode) { // Clean up if constructor failed
                     try { html5QrCode.stop().catch(()=>{}); } catch(e){}
                     html5QrCode = null;
                 }
                // Optionally close modal on init failure after a delay
                // setTimeout(closeModalAndBackdrop, 1500);
            }
        }, 250); // Increased delay slightly
     }

    // =============================
    // Detiene el escáner QR
    // =============================
     async function stopQrScanner(keepBackdrop = false) { // Add async and parameter
         const scannerInstance = html5QrCode; // Capture instance
         if (scannerInstance) {
             html5QrCode = null; // Nullify immediately to prevent race conditions
             showLoader();
             console.log("Attempting to stop QR scanner...");
             try {
                 await scannerInstance.stop();
                 console.log("QR Code scanning stopped successfully via stop().");
                 // Clear might be needed depending on library version/state
                 if (typeof scannerInstance.clear === 'function') {
                     await scannerInstance.clear();
                     console.log("QR Code scanner cleared.");
                 }
             } catch (err) {
                 console.warn("Issue stopping/clearing QR scanner:", err);
                 // If stop fails, the camera might remain active, attempt workaround
                 const readerEl = document.getElementById('qr-reader');
                 if (readerEl) readerEl.innerHTML = ''; // Clear the container as fallback
             } finally {
                 hideLoader();
                 qrScannerModal.classList.remove('active');
                 if (!keepBackdrop && !document.querySelector('.modal.active')) {
                     modalBackdrop.classList.remove('active');
                 }
             }
         } else {
             // If no instance, just ensure modal is closed
             qrScannerModal.classList.remove('active');
             if (!keepBackdrop && !document.querySelector('.modal.active')) {
                 modalBackdrop.classList.remove('active');
             }
         }
     }


    scanQrMainBtn.addEventListener('click', startQrScanner);
    // closeQrScannerBtn listener is now part of closeModalAndBackdrop

    // --- END QR SCANNER LOGIC ---


    // =============================
    // Inicialización principal de la app
    // =============================
    initDatabase().then(() => {
        renderTable(products); // Initial render
        switchTab('verificar'); // Set initial tab
        console.log('Aplicación inicializada.');
        showToast('Aplicación lista.', 'success'); // User feedback
    }).catch(error => {
        console.error('Error fatal al inicializar la aplicación:', error);
         showToast(`Error crítico: ${error.message}`, 'error');
         updateDbStatus('❌ ERROR FATAL DB', 'error');
         // Optionally disable parts of the UI if DB is essential
         document.querySelectorAll('button, input, select').forEach(el => el.disabled = true);
    });

    // Add keyboard navigation for tabs
    const tablist = document.querySelector('[role="tablist"]');
    const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
    tablist.addEventListener('keydown', (e) => {
        let currentTab = document.activeElement;
        let currentIndex = tabs.indexOf(currentTab);

        if (currentIndex === -1) return; // Not focused on a tab button

        let nextIndex;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            nextIndex = (currentIndex + 1) % tabs.length;
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
        } else {
            return; // Ignore other keys
        }

        e.preventDefault(); // Prevent scrolling
        tabs[nextIndex].focus();
        // Optionally switch tab on arrow key navigation
        // switchTab(tabs[nextIndex].dataset.tab);
    });

    // Centralized listener initialization: replace nodes to remove prior listeners and attach ours
    function initListeners() {
        try {
            const safeReplace = (el) => { if (!el) return null; const clone = el.cloneNode(true); el.replaceWith(clone); return clone; };

            const exportBtn = safeReplace(document.getElementById('export-btn'));
            if (exportBtn) exportBtn.addEventListener('click', exportToCSV);

            const printBtn = safeReplace(document.getElementById('print-btn'));
            if (printBtn) printBtn.addEventListener('click', printReport);

            const applyFiltersBtn = safeReplace(document.getElementById('apply-filters'));
            if (applyFiltersBtn) applyFiltersBtn.addEventListener('click', loadHistoryContent);

            const exportHistoryBtn = safeReplace(document.getElementById('export-history'));
            if (exportHistoryBtn) exportHistoryBtn.addEventListener('click', exportHistory);

            const exportAllBtn = safeReplace(document.getElementById('export-all-data'));
            if (exportAllBtn) exportAllBtn.addEventListener('click', exportAllData);

            const cleanOldBtn = safeReplace(document.getElementById('clean-old-data'));
            if (cleanOldBtn) cleanOldBtn.addEventListener('click', cleanOldData);

            const clearAllBtn = safeReplace(document.getElementById('clear-all-data'));
            if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllData);

            const historyTableBodyEl = safeReplace(document.getElementById('history-table-body'));
            if (historyTableBodyEl) {
                historyTableBodyEl.addEventListener('click', (e) => {
                    const viewBtn = e.target.closest('.view-details-btn');
                    if (viewBtn && viewBtn.dataset.id) {
                        try { showVerificationDetails(parseInt(viewBtn.dataset.id, 10)); } catch (error) { console.error('Error parsing verification ID', error); }
                    }
                });
            }

            const commitSessionBtn = safeReplace(document.getElementById('commit-session-btn'));
            if (commitSessionBtn) commitSessionBtn.addEventListener('click', commitSessionToHistory);

            const scanQrMainBtnLocal = safeReplace(document.getElementById('scan-qr-main-btn'));
            if (scanQrMainBtnLocal) scanQrMainBtnLocal.addEventListener('click', startQrScanner);

            const searchInputLocal = safeReplace(document.getElementById('searchInput'));
            if (searchInputLocal) searchInputLocal.addEventListener('input', filterAndRender);

            const photoQuality = safeReplace(document.getElementById('photo-quality'));
            if (photoQuality) photoQuality.addEventListener('change', (e) => { localStorage.setItem('photoQuality', e.target.value); showToast('Calidad de fotos guardada.', 'success'); });

            const photoMaxSize = safeReplace(document.getElementById('photo-max-size'));
            if (photoMaxSize) photoMaxSize.addEventListener('change', (e) => { localStorage.setItem('photoMaxSize', e.target.value); showToast('Tamaño máximo de foto guardado.', 'success'); });

            const refreshDiag = safeReplace(document.getElementById('refresh-diagnostic-btn'));
            if (refreshDiag) refreshDiag.addEventListener('click', () => { runDiagnostic().catch(err => console.error(err)); });

            // Modal backdrop and close buttons
            const backdrop = safeReplace(document.getElementById('modal-backdrop'));
            if (backdrop) backdrop.addEventListener('click', closeModalAndBackdrop);
            const closeModalBtnLocal = safeReplace(document.getElementById('close-modal-btn'));
            if (closeModalBtnLocal) closeModalBtnLocal.addEventListener('click', closeModalAndBackdrop);
            const cancelBtnLocal = safeReplace(document.getElementById('cancel-btn'));
            if (cancelBtnLocal) cancelBtnLocal.addEventListener('click', closeModalAndBackdrop);
            const closeHistoryBtn = safeReplace(document.getElementById('close-history-modal'));
            if (closeHistoryBtn) closeHistoryBtn.addEventListener('click', closeModalAndBackdrop);
            const closeQrBtn = safeReplace(document.getElementById('close-qr-scanner-btn'));
            if (closeQrBtn) closeQrBtn.addEventListener('click', closeModalAndBackdrop);

            console.log('initListeners: listeners attached');
        } catch (err) {
            console.error('initListeners error:', err);
        }
    }

    // Initialize centralized listeners
    initListeners();

}); // End DOMContentLoaded

    // ========================================
    // UX IMPROVEMENTS - Toast/Loader/Confirm (AÑADIDO)
    // ========================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) {
             console.warn("Toast container not found!");
             return;
        }
        const toast = document.createElement('div');
        const iconClass = {
            success: 'fa-check-circle',
            error: 'fa-times-circle',
            info: 'fa-info-circle'
        }[type] || 'fa-info-circle'; // Default icon
        toast.className = `toast ${type}`; // Add class first
        // Sanitize message before inserting as HTML
        const safeMessage = String(message).replace(/</g, "&lt;").replace(/>/g, "&gt;");
        toast.innerHTML = `<i class="fas ${iconClass}" aria-hidden="true"></i><span class="ml-2">${safeMessage}</span>`; // Added ml-2 for spacing
         toast.setAttribute('role', 'alert'); // Accessibility
         toast.setAttribute('aria-live', 'assertive');

        container.appendChild(toast);

        // Trigger transition using requestAnimationFrame for reliability
        requestAnimationFrame(() => {
             requestAnimationFrame(() => { // Double RAF for some browsers
                 toast.classList.add('show');
             });
        });


        // Auto-dismiss after a delay
        setTimeout(() => {
            toast.classList.remove('show');
            // Remove element after transition finishes
             toast.addEventListener('transitionend', () => {
                 if (toast.parentElement === container) { // Check if still attached
                     container.removeChild(toast);
                 }
             }, {once: true});
        }, 4000); // 4 seconds duration

         // Allow manual dismissal by clicking the toast
         toast.addEventListener('click', () => {
             toast.classList.remove('show');
             toast.addEventListener('transitionend', () => {
                  if (toast.parentElement === container) {
                      container.removeChild(toast);
                  }
             }, {once: true});
         }, {once: true}); // Click only once to dismiss
    }


    function showLoader() {
        const loader = document.getElementById('loader-backdrop');
        if (loader) loader.classList.add('active');
    }

    function hideLoader() {
        const loader = document.getElementById('loader-backdrop');
        if (loader) loader.classList.remove('active');
    }

    function showConfirmation(title, message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirm-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const titleEl = document.getElementById('confirm-title');
            const messageEl = document.getElementById('confirm-message');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            if (!modal || !backdrop || !titleEl || !messageEl || !okBtn || !cancelBtn) {
                console.error("Faltan elementos del modal de confirmación");
                return resolve(false); // Falla de forma segura
            }

            // Store existing focused element to restore later
            const previouslyFocusedElement = document.activeElement;

            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.add('active');

            backdrop.classList.add('active');

             // Focus management for accessibility - focus OK button by default
             okBtn.focus();


            const cleanup = (result) => {
                modal.classList.remove('active');
                // Hide backdrop only if no other modal is active
                if (!document.querySelector('.modal.active')) {
                    backdrop.classList.remove('active');
                }
                // Remove listeners to prevent memory leaks
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                document.removeEventListener('keydown', handleKeyDown);


                // Restore focus
                if (previouslyFocusedElement && typeof previouslyFocusedElement.focus === 'function') {
                    // Try/catch just in case the element is no longer focusable
                    try { previouslyFocusedElement.focus(); } catch (e) { console.warn("Could not restore focus"); }
                }

                resolve(result);
            };

             // Define handlers separately to allow removal
             const handleOk = () => cleanup(true);
             const handleCancel = () => cleanup(false);
             const handleKeyDown = (event) => {
                if (event.key === 'Escape') {
                    handleCancel();
                } else if (event.key === 'Tab') {
                     // Basic focus trapping (can be enhanced)
                     const focusableElements = [cancelBtn, okBtn];
                     const currentIndex = focusableElements.indexOf(document.activeElement);
                     let nextIndex;
                     if (event.shiftKey) {
                         nextIndex = (currentIndex - 1 + focusableElements.length) % focusableElements.length;
                     } else {
                         nextIndex = (currentIndex + 1) % focusableElements.length;
                     }
                     event.preventDefault();
                     focusableElements[nextIndex].focus();
                }
            };


            // Add listeners
            okBtn.addEventListener('click', handleOk, { once: true });
            cancelBtn.addEventListener('click', handleCancel, { once: true });
            document.addEventListener('keydown', handleKeyDown);

        });
    }

</script>

</body>
</html>

